<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title id="pageTitle">本穴世界</title>

    <style>
body{background:#222;color:#fff;font-family:"微软雅黑",Arial,sans-serif;display:flex;flex-direction:column;align-items:center;min-height:100vh}.controls{margin:20px 0}.counter-container{margin:10px 0 0px 0;display:flex;align-items:center;gap:8px}.counter-container input{width:60px;text-align:center;font-size:18px;border-radius:5px;border:none;padding:4px 6px}.counter-container button{padding:4px 10px;font-size:16px;border-radius:5px;border:none;background:#3498db;color:#fff;cursor:pointer;transition:background 0.2s}.counter-container button:hover{background:#217dbb}#toolsPanelBtn{background:#4a5568 !important;color:#fff !important}#toolsPanelBtn:hover{background:#2d3748 !important}.circle-container{position:relative;width:600px;height:600px;margin:0 auto}button{margin:0 8px;padding:6px 16px;font-size:16px;border-radius:6px;border:none;background:#e74c3c;color:#fff;cursor:pointer;transition:background 0.2s}button:hover{background:#c0392b}footer a{color:#444 !important;text-decoration:none}footer a:visited,footer a:hover,footer a:active{color:#444 !important}.seat{position:absolute;width:100px;height:60px;background:#444;border-radius:30px;box-shadow:0 2px 8px #0006;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:background 0.2s}.seat .name-edit{width:70px;text-align:center;border:none;border-radius:5px;padding:2px 4px;margin-top:4px;font-size:14px;background:#fff;color:#222;cursor:pointer;position:relative}.seat .name-edit[disabled]{background:#aaa;color:#666;cursor:not-allowed}.seat .dropdown-list{display:none;position:absolute;left:0;top:100%;min-width:120px;max-width:300px;width:max-content;background:#fff;color:#222;border-radius:5px;box-shadow:0 2px 8px #0006;z-index:10;max-height:180px;overflow-y:auto;white-space:nowrap;padding:4px 0}.seat .dropdown-list.show{display:block}.seat.dropdown-active{z-index:100}.seat .dropdown-group-title{font-weight:bold;padding:6px 10px 2px 10px;color:#888;font-size:13px}.seat .dropdown-item{padding:6px 10px;cursor:pointer;white-space:nowrap;border-left:6px solid transparent;transition:background 0.2s,border-color 0.2s}.seat .dropdown-item.song{border-left-color:#2980b9}.seat .dropdown-item.outsider{border-left-color:#f1c40f}.seat .dropdown-item.mongolia{border-left-color:#e74c3c}.seat .dropdown-item.third{border-left-color:#27ae60}.seat .dropdown-item:hover{background:#3498db;color:#fff}.seat-number{font-weight:bold;font-size:18px}.seat.death,.seat.suicide{background:#222;opacity:0.6}.seat.out{background:#222;opacity:0.7}.seat.flipped{box-shadow:0 0 12px rgba(52,152,219,0.6)}.seat.surrendered{box-shadow:0 0 12px rgba(155,89,182,0.6)}.seat.highlight{box-shadow:0 0 16px 4px #ff3333,0 2px 8px #0006;background:#a94442 !important;color:#fff !important}.seat.selected-first{box-shadow:0 0 16px 4px #27ae60,0 2px 8px #0006;background:#556b55 !important;color:#fff !important}.seat.selected-other{box-shadow:0 0 16px 4px #f1c40f,0 2px 8px #0006;background:#6b6255 !important;color:#fff !important}.seat-votes{position:absolute;left:50%;top:100%;transform:translateX(-50%);display:flex;flex-direction:row;gap:2px;margin-top:2px;z-index:2;pointer-events:none}.role-counter-toggle{position:absolute;right:-8px;top:-8px;width:20px;height:20px;background:#27ae60;color:#fff;border-radius:50%;border:none;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5;transition:all 0.2s;padding:6px 6px}.role-counter-toggle:hover{background:#1f884b}.role-counter-buttons{position:absolute;left:100%;top:50%;transform:translateY(-50%);margin-left:8px;display:none;flex-direction:column;gap:4px;background:rgba(0,0,0,0.8);padding:6px 8px;border-radius:8px;z-index:20;white-space:nowrap}.role-counter-buttons.show{display:flex}.role-counter-btn{padding:3px 8px;border-radius:4px;border:none;color:#fff;cursor:pointer;transition:background 0.2s;min-width:28px}.role-counter-btn.negative{background:#3498db}.role-counter-btn.negative:hover{background:#217dbb}.role-counter-btn.positive{background:#27ae60}.role-counter-btn.positive:hover{background:#1f884b}.vote-area-container{margin:30px auto 0 auto;display:flex;flex-direction:column;align-items:center}.vote-area-header{width:100%;display:flex;justify-content:flex-end;align-items:center;margin-bottom:8px}.vote-area{background:#333;border-radius:12px;display:flex;flex-wrap:nowrap;gap:8px;padding:10px 10px 10px 10px;box-sizing:border-box;justify-content:center;overflow-x:auto;overflow-y:hidden;margin:0 auto;transition:width 0.2s}.vote-card,.seat-vote-card{background:#fff;border-radius:6px;box-shadow:0 2px 8px #0006;display:flex;align-items:center;justify-content:center;font-weight:bold;cursor:grab;position:relative;flex-shrink:0}.vote-card{width:36px;height:36px;color:#3498db;border:2px solid #3498db;font-size:18px;user-select:none;transition:background 0.2s,color 0.2s}.seat-vote-card{width:22px;height:22px;color:#e67e22;border:2px solid #e67e22;font-size:14px;margin:0 1px;pointer-events:auto}.vote-card.dragging{opacity:0.5}.vote-reset-btn,.copy-votes-btn,.history-clear-btn,.history-export-btn{border-radius:6px;padding:4px 14px;font-size:15px;border:none;cursor:pointer;transition:background 0.2s}.vote-reset-btn{background:#888;color:#fff;margin-left:10px}.vote-reset-btn:hover{background:#555}.copy-votes-btn{background:#27ae60;color:#fff;margin-right:10px}.copy-votes-btn:hover{background:#1f884b}.history-panel{position:fixed;left:20px;bottom:20px;width:360px;background:rgba(0,0,0,0.85);border:1px solid #444;border-radius:8px;color:#fff;font-size:14px;z-index:1000;display:flex;flex-direction:column;user-select:none}.history-header{padding:8px 12px;background:rgba(68,68,68,0.8);border-bottom:1px solid #555;border-radius:8px 8px 0 0;font-weight:bold;display:flex;justify-content:space-between;align-items:center;cursor:move}.history-panel.dragging{opacity:0.8;box-shadow:0 4px 20px rgba(0,0,0,0.5)}.history-buttons{display:flex;gap:4px}.history-clear-btn{background:#666;color:#fff;padding:2px 6px;font-size:12px}.history-clear-btn:hover{background:#888}.history-export-btn{background:#0066cc;color:#fff;padding:2px 6px;font-size:12px}.history-export-btn:hover{background:#0088ff}.history-content{padding:8px 12px;overflow-y:auto;flex:1}.history-content::-webkit-scrollbar{width:8px}.history-content::-webkit-scrollbar-track{background:rgba(255,255,255,0.1);border-radius:4px}.history-content::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:4px;transition:background 0.2s}.history-content::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.5)}.history-resize-handle{position:absolute;bottom:0;right:0;width:12px;height:12px;background:rgba(255,255,255,0.3);cursor:nw-resize;border-radius:8px 0 8px 0;transition:background 0.2s}.history-resize-handle:hover{background:rgba(255,255,255,0.5)}.history-resize-handle::before{content:'';position:absolute;bottom:2px;right:2px;width:0;height:0;border-left:6px solid transparent;border-bottom:6px solid rgba(255,255,255,0.6)}.history-item{margin:4px 0;padding:4px 6px;border-radius:4px;background:rgba(255,255,255,0.1);border-left:3px solid transparent;position:relative}.history-item.death{border-left-color:#e74c3c}.history-item.out{border-left-color:#f39c12}.history-item.suicide{border-left-color:#8B0000}.history-item.flip{border-left-color:#3498db}.history-item.surrender{border-left-color:#9b59b6}.history-item.economy_gain{border-left-color:#27ae60}.history-item.economy_loss{border-left-color:#3498db}.history-item.vote_summary{border-left-color:#9b59b6}.history-item.economy{border-left-color:#f1c40f;background:rgba(241,196,15,0.2)}.history-item.skill{border-left-color:#3498db}.history-item.seat_pick{border-left-color:#9b59b6;background:rgba(155,89,182,0.2)}.history-item .seat-number{font-weight:bold;color:#3498db}.history-item .character-name{color:#2ecc71}.history-item .action{color:#fff}.history-item .delete-btn{position:absolute;right:4px;top:4px;width:16px;height:16px;background:rgba(231,76,60,0.7);color:#fff;border:none;border-radius:50%;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center;transition:all 0.2s;line-height:1;padding:0}.history-item:hover .delete-btn{display:flex}.history-item .delete-btn:hover{background:rgba(231,76,60,1);transform:scale(1.1)}.history-item .copy-btn{position:absolute;right:24px;top:4px;width:16px;height:16px;background:rgba(52,152,219,0.7);color:#fff;border:none;border-radius:50%;font-size:8px;cursor:pointer;display:none;align-items:center;justify-content:center;transition:all 0.2s;line-height:1;padding:0}.history-item:hover .copy-btn{display:flex}.history-item .copy-btn:hover{background:rgba(52,152,219,1);transform:scale(1.1)}.phase-panel{position:fixed;right:20px;top:20px;width:280px;background:rgba(0,0,0,0.85);border:1px solid #444;border-radius:8px;color:#fff;font-size:14px;z-index:1000;display:flex;flex-direction:column;user-select:none}.phase-header{padding:8px 12px;background:rgba(68,68,68,0.8);border-bottom:1px solid #555;border-radius:8px 8px 0 0;font-weight:bold;display:flex;justify-content:space-between;align-items:center;cursor:move}.phase-panel.dragging{opacity:0.8;box-shadow:0 4px 20px rgba(0,0,0,0.5)}.phase-content{padding:12px;display:flex;flex-direction:column;gap:8px}.phase-time{font-size:18px;font-weight:bold;text-align:center;padding:8px;border-radius:6px;background:rgba(255,255,255,0.1)}.phase-time.day{background:rgba(255,193,7,0.3);color:#ffc107}.phase-time.night{background:rgba(33,37,41,0.8);color:#6c757d}.phase-day-container{display:flex;align-items:center;justify-content:center;gap:8px;margin:4px 0}.phase-day{font-size:14px;font-weight:bold;text-align:center;padding:4px 8px;border-radius:4px;background:rgba(52,152,219,0.2);color:#3498db;flex:1;min-width:60px}.day-counter-btn{width:24px;height:24px;border:1px solid #3498db;background:rgba(52,152,219,0.1);color:#3498db;border-radius:4px;cursor:pointer;font-size:14px;font-weight:bold;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease}.day-counter-btn:hover{background:rgba(52,152,219,0.3);transform:scale(1.1)}.day-counter-btn:active{transform:scale(0.95)}.phase-settlement{background:rgba(52,152,219,0.2);border:1px solid #3498db;border-radius:6px;padding:8px;text-align:center;min-height:40px;display:flex;align-items:center;justify-content:center}.phase-settlement.empty{color:#888;font-style:italic}.phase-controls{display:flex;gap:6px;justify-content:center}.phase-btn{padding:6px 12px;border:none;border-radius:4px;background:#3498db;color:#fff;cursor:pointer;font-size:12px;transition:background 0.2s}.phase-btn:hover{background:#217dbb}.phase-btn.day-night{background:#f39c12}.phase-btn.day-night:hover{background:#d68910}.phase-btn:disabled{background:#666;cursor:not-allowed}.seat-picker{position:fixed;left:20px;top:50%;transform:translateY(-50%);width:200px;background:rgba(0,0,0,0.85);border:1px solid #444;border-radius:8px;color:#fff;font-size:14px;z-index:1000;display:flex;flex-direction:column;user-select:none}.seat-picker-header{padding:8px 12px;background:rgba(68,68,68,0.8);border-bottom:1px solid #555;border-radius:8px 8px 0 0;font-weight:bold;text-align:center;cursor:move}.seat-picker.dragging{opacity:0.8;box-shadow:0 4px 20px rgba(0,0,0,0.5)}.seat-picker-content{padding:12px;display:flex;flex-direction:column;gap:12px;align-items:center}.seat-picker-result{font-size:24px;font-weight:bold;text-align:center;padding:12px;border-radius:6px;background:rgba(255,255,255,0.1);color:#3498db;min-height:48px;display:flex;align-items:center;justify-content:center;width:100%;box-sizing:border-box;transition:all 0.3s ease;border:2px solid transparent}.seat-picker-result.highlight{background:rgba(52,152,219,0.3);border-color:#3498db;box-shadow:0 0 10px rgba(52,152,219,0.5)}.seat-picker-btn{padding:8px 16px;border:none;border-radius:6px;background:#27ae60;color:#fff;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.2s;width:100%}.seat-picker-btn:hover{background:#1f884b;transform:translateY(-1px)}.seat-picker-btn:active{transform:translateY(0)}.seat-picker-btn:disabled{background:#666;cursor:not-allowed;transform:none}.death-marker{width:40px;height:40px;background:url('https://img.icons8.com/?size=100&id=zZo1Yf9pQBEb&format=png&color=000000') no-repeat center/contain;border-radius:50%;border:2px solid #fff;position:fixed;left:20px;top:100px;cursor:grab;z-index:1000}.out-marker{width:40px;height:40px;background:url('https://img.icons8.com/?size=100&id=V5goKm6cjMTm&format=png&color=000000') no-repeat center/contain;border-radius:50%;border:2px solid #fff;position:fixed;left:20px;top:160px;cursor:grab;z-index:1000}.suicide-marker{width:40px;height:40px;background:url('https://img.icons8.com/?size=100&id=WbzwgmqepcuN&format=png&color=000000') no-repeat center/contain;border-radius:50%;border:2px solid #fff;position:fixed;left:20px;top:220px;cursor:grab;z-index:1000}.flip-marker{width:40px;height:40px;background:#3498db;border-radius:50%;border:2px solid #fff;position:fixed;left:20px;top:280px;cursor:grab;z-index:1000;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;color:#fff}.flip-marker::before{content:'翻'}.surrender-marker{width:40px;height:40px;background:#9b59b6;border-radius:50%;border:2px solid #fff;position:fixed;left:20px;top:340px;cursor:grab;z-index:1000;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;color:#fff}.surrender-marker::before{content:'叛'}.seat .death-icon::before{content:'';display:block;width:28px;height:28px;background:url('https://img.icons8.com/?size=100&id=zZo1Yf9pQBEb&format=png&color=000000') no-repeat center/contain}.seat .out-icon::before{content:'';display:block;width:28px;height:28px;background:url('https://img.icons8.com/?size=100&id=V5goKm6cjMTm&format=png&color=000000') no-repeat center/contain;filter:drop-shadow(0 0 2px #4b4b4b)}.seat .suicide-icon::before{content:'';display:block;width:28px;height:28px;background:url('https://img.icons8.com/?size=100&id=WbzwgmqepcuN&format=png&color=000000') no-repeat center/contain}.seat .flip-icon{position:absolute;left:-5px;top:-5px;font-size:30px;font-weight:bold;text-shadow:0 0 3px rgba(52,152,219,0.8),0 0 1px #000;cursor:grab;z-index:10;opacity:0.5;color:#3498db}.seat .surrender-icon{position:absolute;left:-5px;top:-5px;font-size:30px;font-weight:bold;text-shadow:0 0 3px rgba(155,89,182,0.8),0 0 1px #000;cursor:grab;z-index:10;opacity:0.5;color:#9b59b6}.seat .death-icon,.seat .suicide-icon,.seat .out-icon{width:28px;height:28px;margin-top:2px;cursor:grab}.version-notification{position:fixed;top:20px;right:20px;z-index:10000;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.15);border:1px solid #e1e5e9;min-width:320px;max-width:400px;animation:slideIn 0.3s ease-out}.version-notification.checking{background:#f8f9fa;border-color:#dee2e6}.version-notification.error{background:#fff5f5;border-color:#fed7d7}.version-notification-content{padding:0}.version-notification-header{display:flex;justify-content:space-between;align-items:center;padding:16px 16px 0 16px}.version-notification-title{font-size:16px;font-weight:600;color:#2d3748}.version-notification-close{background:none;border:none;font-size:20px;color:#a0aec0;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all 0.2s ease}.version-notification-close:hover{background:#edf2f7;color:#4a5568}.version-notification-body{padding:12px 16px 16px 16px}.version-notification-body p{margin:0 0 8px 0;font-size:14px;color:#4a5568;line-height:1.5}.version-notification-body p:last-child{margin-bottom:0}.version-update-available{color:#38a169 !important;font-weight:500}.version-up-to-date{color:#319795 !important;font-weight:500}.version-setup-needed{color:#d69e2e !important;font-weight:500}.version-notification-actions{margin-top:12px;display:flex;gap:8px}.version-btn{padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;text-decoration:none;border:none;cursor:pointer;transition:all 0.2s ease;display:inline-flex;align-items:center;justify-content:center}.version-btn-primary{background:#3182ce;color:#fff}.version-btn-primary:hover{background:#2c5aa0;color:#fff}.version-btn-secondary{background:#edf2f7;color:#4a5568}.version-btn-secondary:hover{background:#e2e8f0}#versionCheckBtn{background:#4a5568;color:#fff;border:none;padding:8px 12px;border-radius:4px;font-size:14px;cursor:pointer;transition:background-color 0.2s ease}#versionCheckBtn:hover{background:#2d3748}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}.version-notification.slide-out{animation:slideOut 0.3s ease-in forwards}@media (max-width:480px){.version-notification{left:10px;right:10px;top:10px;min-width:auto;max-width:none}.version-notification-actions{flex-direction:column}.version-btn{width:100%}}.role-info-panel{position:fixed;right:20px;top:280px;width:280px;background:rgba(0,0,0,0.85);border:1px solid #444;border-radius:8px;color:#fff;font-size:14px;z-index:1000;display:flex;flex-direction:column;user-select:none}.role-info-header{padding:8px 12px;background:rgba(68,68,68,0.8);border-bottom:1px solid #555;border-radius:8px 8px 0 0;font-weight:bold;display:flex;justify-content:space-between;align-items:center;cursor:move}.role-info-panel.dragging{opacity:0.8;box-shadow:0 4px 20px rgba(0,0,0,0.5)}.role-info-content{padding:12px;min-height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center}.role-info-empty{color:#999;font-style:italic;text-align:center}.role-info-name{font-weight:bold;font-size:18px;margin-bottom:8px;text-align:center}.role-info-faction{font-size:14px;color:#ccc;text-align:center;margin-bottom:4px}.role-info-seat{font-size:12px;color:#888;text-align:center}.role-info-panel.song .role-info-name{color:#2980b9}.role-info-panel.song{border-color:#2980b9}.role-info-panel.outsider .role-info-name{color:#f1c40f}.role-info-panel.outsider{border-color:#f1c40f}.role-info-panel.mongolia .role-info-name{color:#e74c3c}.role-info-panel.mongolia{border-color:#e74c3c}.role-info-panel.third .role-info-name{color:#27ae60}.role-info-panel.third{border-color:#27ae60}.role-info-panel.unknown .role-info-name{color:#999}.role-info-panel.unknown{border-color:#666}#toolsPanel{display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:9999;background:rgba(0,0,0,0.6);align-items:center;justify-content:center}.tools-panel-content{background:rgba(0,0,0,0.85);border:1px solid #444;border-radius:8px;min-width:360px;max-width:500px;color:#fff;font-family:"微软雅黑",Arial,sans-serif;display:flex;flex-direction:column;user-select:none;box-shadow:0 4px 20px rgba(0,0,0,0.5)}.tools-panel-title{padding:12px 16px;background:rgba(68,68,68,0.8);border-bottom:1px solid #555;border-radius:8px 8px 0 0;font-size:16px;font-weight:bold;text-align:center}.tools-section{padding:16px;border-bottom:1px solid #333}.tools-section:last-of-type{border-bottom:none}.tools-section-title{font-size:14px;color:#ccc;margin-bottom:8px;font-weight:500}.tools-role-filter-input{width:100%;height:80px;font-size:14px;padding:8px 12px;border-radius:6px;border:1px solid #555;background:rgba(255,255,255,0.1);color:#fff;resize:vertical;outline:none;transition:border-color 0.2s ease,background 0.2s ease;box-sizing:border-box;font-family:"微软雅黑",Arial,sans-serif}.tools-role-filter-input:focus{border-color:#3498db;background:rgba(255,255,255,0.15)}.tools-role-filter-input::placeholder{color:#888}.tools-btn{padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-family:"微软雅黑",Arial,sans-serif;font-weight:500;transition:background-color 0.2s ease;margin:0;letter-spacing:0.5px}.tools-btn-success{background:#4a5568;color:#fff}.tools-btn-success:hover{background:#2d3748}.tools-btn-info{background:linear-gradient(135deg,#4a5568 0%,#2d3748 100%);color:#fff;border:1px solid #60a5fa;margin-bottom:8px;display:block;width:100%;transition:all 0.3s ease;box-shadow:0 2px 4px rgba(0,0,0,0.2);position:relative;overflow:hidden;text-align:center}.tools-btn-info:hover{background:linear-gradient(135deg,#3498db 0%,#2980b9 100%);border-color:#74c0fc;color:#fff;transform:translateY(-1px);box-shadow:0 4px 8px rgba(52,152,219,0.3)}.tools-btn-info:active{transform:translateY(0);box-shadow:0 2px 4px rgba(0,0,0,0.2)}.tools-btn-info::after{content:"";position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,0.3);transform:translate(-50%,-50%);transition:width 0.6s,height 0.6s,opacity 0.6s;opacity:0;pointer-events:none}.tools-btn-info:active::after{width:300px;height:300px;opacity:1;transition:0s}.tools-btn-danger{background:#888;color:#fff;padding:8px 20px;margin:16px auto 16px auto;display:block}.tools-btn-danger:hover{background:#666}@media (max-width:600px){.tools-panel-content{min-width:300px;margin:20px}.tools-section{padding:12px}}.changelog-dialog-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;animation:fadeIn 0.3s ease-out}.changelog-dialog{background:#2d2d2d;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.3);max-width:600px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;animation:slideIn 0.3s ease-out;color:#fff}.changelog-dialog-large{max-width:800px;max-height:85vh}.changelog-dialog-small{max-width:400px;max-height:300px}.changelog-header{background:#3a3a3a;padding:16px 20px;border-bottom:1px solid #444;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}.changelog-header h3{margin:0;color:#fff;font-size:18px;font-weight:600}.changelog-date{color:#888;font-size:14px;margin-left:12px}.changelog-close{background:none;border:none;color:#888;font-size:24px;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all 0.2s ease}.changelog-close:hover{background:#444;color:#fff}.changelog-content{padding:20px;overflow-y:auto;flex:1;min-height:0}.changelog-list{margin:0;padding-left:20px;color:#ddd;line-height:1.6}.changelog-list li{margin-bottom:8px;color:#ddd}.changelog-list li:last-child{margin-bottom:0}.changelog-comment{color:#4fc3f7 !important;display:block;margin-top:4px;margin-left:0;padding-left:0}.changelog-version{margin-bottom:32px;border-bottom:1px solid #444;padding-bottom:20px}.changelog-version:last-child{margin-bottom:0;border-bottom:none;padding-bottom:0}.changelog-version-header{display:flex;align-items:center;margin-bottom:16px}.changelog-version-header h4{margin:0;color:#4fc3f7;font-size:16px;font-weight:600}.changelog-version-header .changelog-date{margin-left:12px}.changelog-footer{background:#3a3a3a;padding:16px 20px;border-top:1px solid #444;display:flex;gap:12px;justify-content:flex-end;flex-shrink:0}.changelog-btn{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s ease}.changelog-btn-primary{background:rgba(0,0,0,0.3);color:#fff;border:1px solid #888}.changelog-btn-primary:hover{background:rgba(255,255,255,0.1);border-color:#aaa;color:#fff}.changelog-btn-secondary{background:rgba(0,0,0,0.2);color:#ccc;border:1px solid #666}.changelog-btn-secondary:hover{background:rgba(255,255,255,0.05);border-color:#777;color:#fff}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideIn{from{opacity:0;transform:translateY(-20px) scale(0.95)}to{opacity:1;transform:translateY(0) scale(1)}}.changelog-content::-webkit-scrollbar{width:8px}.changelog-content::-webkit-scrollbar-track{background:#444;border-radius:4px}.changelog-content::-webkit-scrollbar-thumb{background:#666;border-radius:4px}.changelog-content::-webkit-scrollbar-thumb:hover{background:#777}.timer{position:fixed;left:20px;bottom:160px;width:200px;background:rgba(0,0,0,0.85);border:1px solid #444;border-radius:8px;color:#fff;font-size:14px;z-index:1000;display:flex;flex-direction:column;user-select:none}.timer-header{padding:8px 12px;background:rgba(68,68,68,0.8);border-bottom:1px solid #555;border-radius:8px 8px 0 0;font-weight:bold;text-align:center;cursor:move}.timer.dragging{opacity:0.8;box-shadow:0 4px 20px rgba(0,0,0,0.5)}.timer-content{padding:12px;display:flex;flex-direction:column;gap:12px;align-items:center}.timer-display{font-size:40px;font-weight:600;text-align:center;padding:12px 16px;border-radius:6px;background:rgba(255,255,255,0.1);color:#fff;min-height:72px;display:flex;align-items:center;justify-content:center;width:100%;box-sizing:border-box;transition:all 0.3s ease;border:2px solid transparent;letter-spacing:2px;line-height:1}.timer-display.highlight{background:rgba(52,152,219,0.3);border-color:#3498db;color:#3498db;box-shadow:0 0 10px rgba(52,152,219,0.5)}.timer-display.warning{background:rgba(241,196,15,0.3);border-color:#f1c40f;color:#f1c40f;box-shadow:0 0 10px rgba(241,196,15,0.5)}.timer-display.danger{background:rgba(231,76,60,0.3);border-color:#e74c3c;color:#e74c3c;box-shadow:0 0 10px rgba(231,76,60,0.5);animation:pulse 1s infinite}@keyframes pulse{0%{opacity:1}50%{opacity:0.7}100%{opacity:1}}@keyframes blink{0%{opacity:1}50%{opacity:0.3}100%{opacity:1}}.timer-display.blink{animation:blink 0.3s ease-in-out}.timer-controls{display:flex;gap:8px;width:100%}.timer-btn{padding:8px 16px;border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.2s;flex:1}.timer-btn-start{background:#27ae60}.timer-btn-start:hover{background:#1f884b;transform:translateY(-1px)}.timer-btn-pause{background:#f39c12}.timer-btn-pause:hover{background:#d4820a;transform:translateY(-1px)}.timer-btn-reset{background:#3498db}.timer-btn-reset:hover{background:#2980b9;transform:translateY(-1px)}.timer-btn:active{transform:translateY(0)}.timer-btn:disabled{background:#666;cursor:not-allowed;transform:none}
    </style>
</head>
<body>
    <h1>本穴世界</h1>
    <!-- 计数器区域 -->
    <div class="counter-container">
        <button id="toolsPanelBtn" onclick="showToolsPanel()">工具设置</button>
        <input type="number" id="counterInput" value="20" onchange="setCounter(this.value)" onkeydown="handleCounterKeydown(event)">
        <button onclick="resetAll()" style="background:#888;color:#fff;">重置全部</button>
    </div>
    <div class="controls">
        <button onclick="removeSeat()">减少座位</button>
        <span id="seatCount"></span>
        <button onclick="addSeat()">增加座位</button>
    </div>
    <div class="death-marker" id="deathMarker" draggable="true" title="拖动到座位上标记死亡"></div>
    <div class="out-marker" id="outMarker" draggable="true" title="拖动到座位上标记票出"></div>
    <div class="suicide-marker" id="suicideMarker" draggable="true" title="拖动到座位上标记自爆"></div>
    <div class="flip-marker" id="flipMarker" draggable="true" title="拖动到座位上标记翻牌"></div>
    <div class="surrender-marker" id="surrenderMarker" draggable="true" title="拖动到座位上标记叛变"></div>
    <div class="circle-container" id="circleContainer"></div>

    <!-- 历史记录框 -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <span>历史记录</span>
            <div class="history-buttons">
                <button class="history-export-btn" onclick="exportHistory()">导出</button>
                <button class="history-clear-btn" onclick="clearHistory()">清空</button>
            </div>
        </div>
        <div class="history-content" id="historyContent">
            <!-- 历史记录将在这里动态添加 -->
        </div>
        <div class="history-resize-handle" id="historyResizeHandle"></div>
    </div>

    <!-- 座位抽取器 -->
    <div class="seat-picker" id="seatPicker">
        <div class="seat-picker-header">
            <span>座位抽取器</span>
        </div>
        <div class="seat-picker-content">
            <div class="seat-picker-result" id="seatPickerResult"></div>
            <button class="seat-picker-btn" id="seatPickerBtn" onclick="pickRandomSeat()">
                随机抽取
            </button>
        </div>
    </div>

    <!-- 倒计时器 -->
    <div class="timer" id="timer" style="display: none;">
        <div class="timer-header">
            <span>倒计时器</span>
        </div>
        <div class="timer-content">
            <div class="timer-display" id="timerDisplay">02:00</div>
            <div class="timer-controls">
                <button class="timer-btn timer-btn-start" id="timerStartBtn" onclick="toggleTimer()">开始</button>
                <button class="timer-btn timer-btn-reset" id="timerResetBtn" onclick="resetTimer()">重置</button>
            </div>
        </div>
    </div>

    <!-- 流程标志窗 -->
    <div class="phase-panel" id="phasePanel">
        <div class="phase-header">
            <span>流程标志</span>
        </div>
        <div class="phase-content">
            <div class="phase-time" id="phaseTime">白天</div>
            <div class="phase-settlement" id="phaseSettlement">
                <span class="empty">无结算角色</span>
            </div>
            <div class="phase-day-container">
                <button class="day-counter-btn" onclick="changeDayCount(-1)" title="减少一天">-</button>
                <div class="phase-day" id="phaseDay">第0天</div>
                <button class="day-counter-btn" onclick="changeDayCount(1)" title="增加一天">+</button>
            </div>
            <div class="phase-controls">
                <button class="phase-btn" id="prevPhaseBtn" onclick="prevPhaseStep()">上一步</button>
                <button class="phase-btn day-night" onclick="toggleDayNight()">切换昼夜</button>
                <button class="phase-btn" id="nextPhaseBtn" onclick="nextPhaseStep()">下一步</button>
            </div>
        </div>
    </div>

    <!-- 工具设置面板 -->
    <div id="toolsPanel">
        <div class="tools-panel-content">
            <div class="tools-panel-title">工具设置</div>
            
            <!-- 身份筛选区域 -->
            <div class="tools-section">
                <div class="tools-section-title">身份筛选</div>
                <textarea id="toolsRoleFilterInput" placeholder="输入身份名关键词，实时筛选..." class="tools-role-filter-input"></textarea>
            </div>
            
            <!-- 版本检查区域 -->
            <div class="tools-section">
                <div class="tools-section-title">版本检查</div>
                <button onclick="versionChecker.manualCheck()" class="tools-btn tools-btn-success">检查更新</button>
            </div>
            
            <!-- 更新公告区域 -->
            <div class="tools-section">
                <div class="tools-section-title">更新公告</div>
                <button onclick="changelogManager.showChangelogDialog()" class="tools-btn tools-btn-info tools-btn-current">查看当前版本公告</button>
                <button onclick="changelogManager.showAllChangelogs()" class="tools-btn tools-btn-info tools-btn-all">查看所有版本公告</button>
            </div>

            <!-- 界面显示区域 -->
            <div class="tools-section">
                <div class="tools-section-title">界面显示</div>
                <label class="tools-checkbox-label">
                    <input type="checkbox" id="timerVisibilityToggle" onchange="toggleTimerVisibility(this.checked)">
                    显示倒计时器
                </label>
            </div>
            
            <!-- 关闭按钮 -->
            <button onclick="closeToolsPanel()" class="tools-btn tools-btn-danger">关闭</button>
        </div>
    </div>

    <!-- 身份筛选弹窗输入框 -->
    <div id="roleFilterDialog" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:9999;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;">
        <div style="background:#fff;padding:20px;border-radius:10px;min-width:340px;box-shadow:0 4px 24px #0005;display:flex;flex-direction:column;align-items:center;">
            <div style="font-size:18px;color:#333;margin-bottom:16px;font-weight:500;">筛选身份</div>
            <textarea id="roleFilterDialogInput" placeholder="身份名关键词" style="width:300px;height:72px;font-size:16px;padding:8px 12px;border-radius:6px;border:1px solid #ddd;resize:vertical;outline:none;transition:border-color 0.2s ease;" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'"></textarea>
        </div>
    </div>

    <!-- 技能备注弹窗 -->
    <div id="skillDialog" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:9999;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;">
        <div style="background:#fff;padding:20px;border-radius:10px;min-width:400px;box-shadow:0 4px 24px #0005;display:flex;flex-direction:column;align-items:center;">
            <div style="font-size:18px;color:#333;margin-bottom:16px;font-weight:500;">发动技能</div>
            <textarea id="skillDialogInput" placeholder="历史记录备注" style="width:360px;height:80px;font-size:16px;padding:8px 12px;border-radius:6px;border:1px solid #ddd;margin-bottom:16px;resize:vertical;outline:none;transition:border-color 0.2s ease;" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'"></textarea>
            
            <!-- 预设按钮区域 -->
            <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;">
                <button onclick="setSkillPreset('只能屯田 只能发动技能')" style="background:#e74c3c;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;">打算</button>
                <button onclick="setSkillPreset('猜测')" style="background:#27ae60;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;">猜测</button>
                <button onclick="setSkillPreset('得知')" style="background:#3498db;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;">得知</button>
                <button onclick="setSkillPreset('询问')" style="background:#f39c12;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;">询问</button>
                <!-- <button onclick="setSkillPreset('')" style="background:#8e44ad;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;"></button>
                <button onclick="setSkillPreset('')" style="background:#16a085;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;"></button> -->
            </div>
        </div>
    </div>

    <!-- 投票牌区域 -->
    <div class="vote-area-container">
        <div class="vote-area-header">
            <button class="copy-votes-btn" onclick="copyVotes()" style="margin-right:auto;">复制票型</button>
            <button class="vote-reset-btn" onclick="resetVotes()">重置投票</button>
        </div>
        <div class="vote-area" id="voteArea"
            ondragover="event.preventDefault()"
            ondrop="onVoteAreaDrop(event)">
        </div>
    </div>

    <script>
        // 流程标志窗相关变量
        let isDayTime = true; // true为白天，false为黑夜
        let currentPhaseStep = 0; // 当前结算步骤索引
        let dayCount = 0; // 当前天数，从第0天开始

        // 投票数据结构：voteMap[seatIndex] = [投给seatIndex的投票人seatIndex, ...]
        let voteMap = [];

        // 历史记录数组
        let history = [];
    </script>
    <script>
const APP_VERSION = "v0.5.3.250726";const APP_NAME = "本穴世界";const charactersDict ={"赵昀":{faction:"南宋",class:"song"},"谢道清":{faction:"南宋",class:"song"},"史弥远":{faction:"南宋",class:"song"},"郑清之":{faction:"南宋",class:"song"},"史嵩之":{faction:"南宋",class:"song",settlements:[{priority:4,text:"史嵩之对一名玩家发动技能",nightRestriction:"any"}]},"贾似道":{faction:"南宋",class:"song",settlements:[{priority:5,text:"贾似道得知一个在场的武将身份和两名玩家",nightRestriction:"firstNight"},{priority:5,text:"贾似道打算两名玩家",nightRestriction:"any"}]},"魏了翁":{faction:"南宋",class:"song",settlements:[{priority:10,text:"魏了翁得知在场的一个身份",nightRestriction:"firstNight"},{priority:10,text:"魏了翁猜测玩家，若正确，得知另一个身份",nightRestriction:"notFirstNight"}]},"刘克庄":{faction:"南宋",class:"song",settlements:[{priority:10,text:"刘克庄得知白天被票出玩家的阵营（受蒲察官奴技能影响）",nightRestriction:"notFirstNight"}]},"吴潜":{faction:"南宋",class:"song",settlements:[{priority:10,text:"吴潜得知最近的存活玩家中是否有蒙古人",nightRestriction:"any"}]},"杜范":{faction:"南宋",class:"song",settlements:[{priority:10,text:"杜范",nightRestriction:"any"}]},"叶适":{faction:"南宋",class:"song",settlements:[{priority:10,text:"叶适查验一名玩家，得知是否是蒙古人",nightRestriction:"any"}]},"谢方叔":{faction:"南宋",class:"song",settlements:[{priority:10,text:"谢方叔",nightRestriction:"any"}]},"陈宜中":{faction:"南宋",class:"song"},"宋慈":{faction:"南宋",class:"song"},"文天祥":{faction:"南宋",class:"song"},"秦九韶":{faction:"南宋",class:"song",settlements:[{priority:10,text:"秦九韶得知开局时的文官武将数",nightRestriction:"firstNight"},{priority:10,text:"秦九韶得知入夜时的文官武将数",nightRestriction:"notFirstNight"}]},"高稼":{faction:"南宋",class:"song",settlements:[{priority:10,text:"高稼保护一名玩家",nightRestriction:"any"}]},"丁大全":{faction:"南宋",class:"song",settlements:[{priority:10,text:"丁大全对一名玩家发动技能",nightRestriction:"any"}]},"孟珙（荆阃）":{faction:"南宋",class:"song",counters:[-10,5,8],settlements:[{priority:6,text:"孟珙",nightRestriction:"any"}]},"赵葵（淮阃）":{faction:"南宋",class:"song",counters:[-8,5,8],settlements:[{priority:10,text:"赵葵",nightRestriction:"any"}]},"余玠（蜀阃）":{faction:"南宋",class:"song",counters:[-8,5,8],settlements:[{priority:10,text:"余玠",nightRestriction:"any"}]},"吕文德（荆阃）":{faction:"南宋",class:"song",counters:[-5,5,8],settlements:[{priority:10,text:"吕文德",nightRestriction:"any"}]},"陈韡（江阃）":{faction:"南宋",class:"song",counters:[-15,5,8],settlements:[{priority:13,text:"陈韡治疗一名玩家",nightRestriction:"firstNight"},{priority:13,text:"陈韡治疗一名其他玩家",nightRestriction:"notFirstNight"}]},"贾涉（淮阃）":{faction:"南宋",class:"song",counters:[-5,5,8]},"安丙（蜀阃）":{faction:"南宋",class:"song",counters:[-15,5,8],settlements:[{priority:12,text:"安丙",nightRestriction:"any"}]},"李曾伯（桂阃）":{faction:"南宋",class:"song",counters:[-8,5,8],settlements:[{priority:10,text:"李曾伯",nightRestriction:"any"}]},"李庭芝（淮阃）":{faction:"南宋",class:"song",counters:[-10,5,8],settlements:[{priority:7,text:"李庭芝",nightRestriction:"any"}]},"杨文（蜀阃）":{faction:"南宋",class:"song",counters:[-7,-5,-3,5,8],settlements:[{priority:8,text:"杨文",nightRestriction:"any"}]},"马光祖（江阃）":{faction:"南宋",class:"song",counters:[-8,5,8]},"张世杰（江阃）":{faction:"南宋",class:"song",settlements:[{priority:0,text:"张世杰得知张弘范位置",nightRestriction:"firstNight"},{priority:10,text:"张世杰屯田",nightRestriction:"any"}]},"夏贵（淮阃）":{faction:"南宋",class:"song",counters:[-10,5,8],settlements:[{priority:10,text:"夏贵",nightRestriction:"any"}]},"赵彦呐（蜀阃）":{faction:"南宋",class:"song",counters:[-8,5,8],settlements:[{priority:10,text:"赵彦呐",nightRestriction:"any"}]},"吕文焕（荆阃）":{faction:"南宋",class:"song",counters:[-10,5,8],settlements:[{priority:10,text:"吕文焕",nightRestriction:"any"}]},"完颜守绪":{faction:"外来者",class:"outsider"},"蒲察官奴":{faction:"外来者",class:"outsider"},"张天纲":{faction:"外来者",class:"outsider",settlements:[{priority:10,text:"张天纲追随一名其他玩家",nightRestriction:"any"}]},"武仙":{faction:"外来者",class:"outsider"},"李遵顼":{faction:"外来者",class:"outsider",settlements:[{priority:10,text:"李遵顼选择一名其他玩家",nightRestriction:"firstNight"}]},"高泰祥":{faction:"外来者",class:"outsider"},"蒲寿庚":{faction:"外来者",class:"outsider",counters:[-5,5],settlements:[{priority:11,text:"蒲寿庚贪污",nightRestriction:"any"}]},"窝阔台":{faction:"蒙古",class:"mongolia",counters:[-3],settlements:[{priority:14,text:"窝阔台劫掠",nightRestriction:"notFirstNight"}]},"拖雷":{faction:"蒙古",class:"mongolia",counters:[-3],settlements:[{priority:14,text:"拖雷劫掠",nightRestriction:"notFirstNight"}]},"蒙哥":{faction:"蒙古",class:"mongolia"},"忽必烈":{faction:"蒙古",class:"mongolia",settlements:[{priority:3,text:"忽必烈议和一名玩家",nightRestriction:"any"}]},"伯颜":{faction:"蒙古",class:"mongolia",settlements:[{priority:11,text:"伯颜劝降",nightRestriction:"any"}]},"刘秉忠":{faction:"蒙古",class:"mongolia"},"塔察儿":{faction:"蒙古",class:"mongolia",settlements:[{priority:11,text:"塔察儿查验一名玩家",nightRestriction:"any"}]},"八思巴":{faction:"蒙古",class:"mongolia",settlements:[{priority:11,text:"八思巴对一名蒙古人发动技能",nightRestriction:"any"}]},"刘整":{faction:"蒙古",class:"mongolia",settlements:[{priority:11,text:"刘整得知最新的蒙古人位置",nightRestriction:"any"}]},"旭烈兀":{faction:"蒙古",class:"mongolia",settlements:[{priority:11,text:"旭烈兀西征",nightRestriction:"any"}]},"兀良合台":{faction:"蒙古",class:"mongolia",settlements:[{priority:11,text:"兀良合台斡腹",nightRestriction:"notFirstNight"}]},"张弘范":{faction:"蒙古",class:"mongolia",settlements:[{priority:0,text:"张弘范得知张世杰位置",nightRestriction:"firstNight"}]},"郝经":{faction:"蒙古",class:"mongolia"},"阔端":{faction:"蒙古",class:"mongolia",counters:[-1,-2,-3,-4,-5,-6],settlements:[{priority:9,text:"阔端投骰子",nightRestriction:"any"},{priority:14,text:"阔端劫掠",nightRestriction:"any"}]},"耶律楚材":{faction:"蒙古",class:"mongolia",settlements:[{priority:11,text:"耶律楚材询问一个身份，得知是否在场",nightRestriction:"any"}]},"李全":{faction:"第三方",class:"third",settlements:[{priority:1,text:"李全选择杨妙真",nightRestriction:"firstNight"}]},"范文虎":{faction:"第三方",class:"third"},"李璮":{faction:"第三方",class:"third",settlements:[{priority:10,text:"李璮寻兵两名其他玩家",nightRestriction:"firstNight"},{priority:10,text:"李璮寻兵一名玩家",nightRestriction:"notFirstNight"}]},"国用安":{faction:"第三方",class:"third"},"汪世显":{faction:"第三方",class:"third"},"丘处机":{faction:"第三方",class:"third"},"杨琏真迦":{faction:"第三方",class:"third",settlements:[{priority:2,text:"杨琏真迦盗墓一名其他玩家",nightRestriction:"firstNight"}]}};function generateNameGroups(charactersDict){const factions ={};for(const [characterName,characterInfo] of Object.entries(charactersDict)){const faction = characterInfo.faction;if(!factions[faction]){factions[faction] ={title:faction,class:characterInfo.class,names:[]};}factions[faction].names.push(characterName);}const factionOrder = ["南宋","外来者","蒙古","第三方"];return factionOrder.map(faction => factions[faction]).filter(Boolean);}const nameGroups = generateNameGroups(charactersDict);const nameList = Object.keys(charactersDict);const roleCounterDict ={};for(const [characterName,characterInfo] of Object.entries(charactersDict)){if(characterInfo.counters){roleCounterDict[characterName] = characterInfo.counters;}}function generateSettlementPriority(charactersDict){const priorityMap = new Map();for(const [characterName,characterInfo] of Object.entries(charactersDict)){if(characterInfo.settlements){for(const settlement of characterInfo.settlements){const priority = settlement.priority;if(!priorityMap.has(priority)){priorityMap.set(priority,[]);}priorityMap.get(priority).push({character:characterName,text:settlement.text,nightRestriction:settlement.nightRestriction || "any"});}}}if(!priorityMap.has(10)){priorityMap.set(10,[]);}priorityMap.get(10).push({character:"蒙古刀人",text:"蒙古刀人",nightRestriction:"any",isFixedSettlement:true});const sortedPriorities = Array.from(priorityMap.keys()).sort((a,b)=> a - b);return sortedPriorities.map(priority => priorityMap.get(priority));}const settlementPriority = generateSettlementPriority(charactersDict);let counter = 20;function updateCounterDisplay(){document.getElementById('counterInput').value = counter;}function changeCounter(delta,seatIndex = null){const oldCounter = counter;counter += delta;updateCounterDisplay();addCounterHistoryRecord(delta,oldCounter,counter,seatIndex);saveState();}function setCounter(val){let num = parseInt(val,10);if(isNaN(num))num = 0;counter = num;updateCounterDisplay();saveState();}function handleCounterKeydown(event){if(event.key === 'Enter'){event.preventDefault();event.target.blur();addEconomyHistoryRecord(counter);}}let roleFilter = "";function showToolsPanel(){document.getElementById('toolsPanel').style.display = 'flex';const input = document.getElementById('toolsRoleFilterInput');input.value = roleFilter;setTimeout(()=> input.focus(),100);}function closeToolsPanel(){document.getElementById('toolsPanel').style.display = 'none';}function applyToolsRoleFilter(){const input = document.getElementById('toolsRoleFilterInput');roleFilter = input.value.trim();renderSeats();renderVoteArea();}function onToolsRoleFilterInput(){const input = document.getElementById('toolsRoleFilterInput');roleFilter = input.value.trim();renderSeats();renderVoteArea();}function generateDropdownHtml(seatIndex,inputValue = '',forceShowAll = false){let dropdownHtml = '';let filterText = roleFilter;if(inputValue === '' || forceShowAll){dropdownHtml = nameGroups.map(group =>{let names = group.names;if(filterText){names = names.filter(name => filterText.split(/\s+/).some(f => f && name.includes(f)));}if(names.length === 0)return '';return ` <div class="dropdown-group-title">${group.title}</div> ${names.map(name => `<div class="dropdown-item ${group.class}" onmousedown="event.stopPropagation();selectName(${seatIndex},'${name}')">${name}</div>`).join('')}`;}).join('');if(dropdownHtml.replace(/\s/g,'')=== ''){dropdownHtml = `<div style="padding:8px 12px;color:#888;">无匹配结果</div>`;}else{dropdownHtml += `<div class="dropdown-item" onmousedown="event.stopPropagation();clearName(${seatIndex})">清空</div>`;}}else{let hasResult = false;dropdownHtml = nameGroups.map(group =>{let filteredNames = group.names.filter(name => name.includes(inputValue));if(filterText){filteredNames = filteredNames.filter(name => filterText.split(/\s+/).some(f => f && name.includes(f)));}if(filteredNames.length === 0)return '';hasResult = true;return ` <div class="dropdown-group-title">${group.title}</div> ${filteredNames.map(name => `<div class="dropdown-item ${group.class}" onmousedown="event.stopPropagation();selectName(${seatIndex},'${name}')">${name}</div>`).join('')}`;}).join('');if(!hasResult){dropdownHtml = `<div style="padding:8px 12px;color:#888;">无匹配结果</div>`;}else{dropdownHtml += `<div class="dropdown-item" onmousedown="event.stopPropagation();clearName(${seatIndex})">清空</div>`;}}return dropdownHtml;}function showRoleFilterDialog(){document.getElementById('roleFilterDialog').style.display = 'flex';const input = document.getElementById('roleFilterDialogInput');input.value = roleFilter;setTimeout(()=> input.focus(),100);}function closeRoleFilterDialog(){document.getElementById('roleFilterDialog').style.display = 'none';}function applyRoleFilter(){const input = document.getElementById('roleFilterDialogInput');roleFilter = input.value.trim();closeRoleFilterDialog();renderSeats();renderVoteArea();}function updateDropdown(index){const inputValue = seats[index].name.trim();const dropdownHtml = generateDropdownHtml(index,inputValue);const dropdown = document.getElementById('dropdown-' + index);if(dropdown)dropdown.innerHTML = dropdownHtml;}function showDropdown(index){document.querySelectorAll('.seat').forEach(seat => seat.classList.remove('dropdown-active'));document.querySelectorAll('.dropdown-list').forEach(el => el.classList.remove('show'));const dropdown = document.getElementById('dropdown-' + index);if(dropdown){dropdown.classList.add('show');const seat = dropdown.closest('.seat');if(seat)seat.classList.add('dropdown-active');}updateDropdown(index);}function initRoleFilterEvents(){const toolsInput = document.getElementById('toolsRoleFilterInput');toolsInput.addEventListener('input',onToolsRoleFilterInput);toolsInput.addEventListener('keydown',function(e){if(e.key === 'Escape')closeToolsPanel();});document.getElementById('toolsPanel').addEventListener('mousedown',function(e){if(e.target === this)closeToolsPanel();});document.getElementById('roleFilterDialogInput').addEventListener('keydown',function(e){if(e.key === 'Enter'){e.preventDefault();applyRoleFilter();}if(e.key === 'Escape')closeRoleFilterDialog();});document.getElementById('roleFilterDialog').addEventListener('mousedown',function(e){if(e.target === this)closeRoleFilterDialog();});document.getElementById('skillDialogInput').addEventListener('keydown',function(e){if(e.key === 'Enter'){e.preventDefault();confirmSkill();}if(e.key === 'Escape')closeSkillDialog();});document.getElementById('skillDialog').addEventListener('mousedown',function(e){if(e.target === this)closeSkillDialog();});document.addEventListener('click',function(e){if(!e.target.matches('.name-edit')&& !e.target.closest('.dropdown-list')){hideAllDropdowns();}});}function hideAllDropdowns(){document.querySelectorAll('.seat').forEach(seat => seat.classList.remove('dropdown-active'));document.querySelectorAll('.dropdown-list').forEach(el => el.classList.remove('show'));}const minSeats = 5;const maxSeats = 20;let seats = [];let selectedSeats = [];function initSeats(count){seats = [];for(let i = 0;i < count;i++){seats.push({name:"",dead:false,out:false,suicide:false,flipped:false,surrendered:false});}voteMap = [];for(let i = 0;i < count;i++)voteMap.push([]);}function renderSeats(){const container = document.getElementById('circleContainer');container.innerHTML = '';const n = seats.length;const radius = 250;const centerX = 300;const centerY = 300;let maxVotes = 0;let votesArr = [];for(let i = 0;i < n;i++){votesArr[i] =(voteMap[i] || []).length;if(!seats[i].dead && votesArr[i] > maxVotes){maxVotes = votesArr[i];}}for(let i = 0;i < n;i++){const angle =(2 * Math.PI / n)* i - Math.PI / 2;const x = centerX + radius * Math.cos(angle)- 50;const y = centerY + radius * Math.sin(angle)- 30;let highlight =(!seats[i].dead && votesArr[i] === maxVotes && maxVotes > 0)? ' highlight':'';let selectedClass = '';if(selectedSeats.includes(i)){if(selectedSeats[0] === i){selectedClass = ' selected-first';}else{selectedClass = ' selected-other';}}const seatDiv = document.createElement('div');seatDiv.className = 'seat' +(seats[i].dead ? ' death':'')+(seats[i].out ? ' out':'')+(seats[i].suicide ? ' suicide':'')+(seats[i].flipped ? ' flipped':'')+(seats[i].surrendered ? ' surrendered':'')+ highlight + selectedClass;seatDiv.style.left = `${x}px`;seatDiv.style.top = `${y}px`;seatDiv.setAttribute('data-index',i);const currentName = seats[i].name.trim();const hasRoleCounters = roleCounterDict.hasOwnProperty(currentName)&& !seats[i].dead && !seats[i].out && !seats[i].suicide;const inputValue = seats[i].name.trim();const dropdownHtml = generateDropdownHtml(i,inputValue);const roleCounterHtml = hasRoleCounters ? `<button class="role-counter-toggle" onclick="toggleRoleCounters(${i})" title="展开专属计数">⚙</button> <div class="role-counter-buttons" id="roleCounters-${i}"> ${roleCounterDict[currentName].map(value => `<button class="role-counter-btn ${value < 0 ? 'negative':'positive'}" onclick="changeCounter(${value},${i})">${value > 0 ? '+' + value:value}</button>`).join('')}</div>`:'';const statusIcons = [ seats[i].dead ? `<div class="death-icon" draggable="true" ondragstart="onSeatDeathDragStart(event,${i})" title="死亡"></div>`:'',seats[i].out ? `<div class="out-icon" draggable="true" ondragstart="onSeatOutDragStart(event,${i})" title="票出"></div>`:'',seats[i].suicide ? `<div class="suicide-icon" draggable="true" ondragstart="onSeatSuicideDragStart(event,${i})" title="自爆"></div>`:'',seats[i].flipped ? `<div class="flip-icon" draggable="true" ondragstart="onSeatFlipDragStart(event,${i})" title="翻牌">翻</div>`:'',seats[i].surrendered ? `<div class="surrender-icon" draggable="true" ondragstart="onSeatSurrenderDragStart(event,${i})" title="叛变">叛</div>`:'' ].filter(icon => icon).join('');seatDiv.innerHTML = ` <div class="seat-number">${i + 1}</div> <div class="name-edit-wrap" style="position:relative;"> <input class="name-edit" type="text" value="${seats[i].name}" onfocus="showDropdown(${i})" onclick="event.stopPropagation();showDropdown(${i})" oninput="updateName(${i},this.value);updateDropdown(${i})" onkeydown="handleNameEditKeyDown(event,${i})" onkeyup="handleNameEditKeyUp(event,${i})" autocomplete="off" /> <div class="dropdown-list" id="dropdown-${i}"> ${dropdownHtml}</div> </div> ${roleCounterHtml}${statusIcons}`;container.appendChild(seatDiv);const nameInput = seatDiv.querySelector('.name-edit');let altListenerAdded = false;let lastAltState = false;function updateDropdownAlt(forceShowAll){const inputValue = seats[i].name.trim();const dropdownHtml = window.generateDropdownHtml(i,inputValue,forceShowAll);const dropdown = document.getElementById('dropdown-' + i);if(dropdown)dropdown.innerHTML = dropdownHtml;}function altKeyHandler(e){if(e.altKey && !lastAltState){e.preventDefault();lastAltState = true;updateDropdownAlt(true);}else if(!e.altKey && lastAltState){lastAltState = false;updateDropdownAlt(false);}}function keyupHandler(e){if(e.key === 'Alt' && lastAltState){e.preventDefault();lastAltState = false;updateDropdownAlt(false);}}nameInput.addEventListener('focus',function(){if(!altListenerAdded){document.addEventListener('keydown',altKeyHandler);document.addEventListener('keyup',keyupHandler);altListenerAdded = true;}});nameInput.addEventListener('blur',function(){if(altListenerAdded){document.removeEventListener('keydown',altKeyHandler);document.removeEventListener('keyup',keyupHandler);altListenerAdded = false;lastAltState = false;updateDropdownAlt(false);}});nameInput.addEventListener('click',function(e){if(e.ctrlKey || e.metaKey){e.preventDefault();e.stopPropagation();toggleSeatSelection(i);}});seatDiv.addEventListener('click',function(e){e.stopPropagation();if(e.ctrlKey || e.metaKey){e.preventDefault();toggleSeatSelection(i);}else{if(selectedSeats.length > 0){clearSeatSelection();}}});seatDiv.ondragover =(e)=>{if(e.dataTransfer.types.includes('vote-card'))e.preventDefault();if(e.dataTransfer.types.includes('text/plain')&& e.dataTransfer.getData('text/plain')=== 'death')e.preventDefault();if(e.dataTransfer.types.includes('text/plain')&& e.dataTransfer.getData('text/plain')=== 'out')e.preventDefault();if(e.dataTransfer.types.includes('text/plain')&& e.dataTransfer.getData('text/plain')=== 'suicide')e.preventDefault();if(e.dataTransfer.types.includes('text/plain')&& e.dataTransfer.getData('text/plain')=== 'flip')e.preventDefault();if(e.dataTransfer.types.includes('text/plain')&& e.dataTransfer.getData('text/plain')=== 'surrender')e.preventDefault();};seatDiv.ondrop =(e)=>{e.preventDefault();if(e.dataTransfer.getData('text/plain')=== 'death'){markDead(i,true);return;}if(e.dataTransfer.getData('text/plain')=== 'out'){markOut(i,!seats[i].out);return;}if(e.dataTransfer.getData('text/plain')=== 'suicide'){markSuicide(i,!seats[i].suicide);return;}if(e.dataTransfer.getData('text/plain')=== 'flip'){markFlipped(i,!seats[i].flipped);return;}if(e.dataTransfer.getData('text/plain')=== 'surrender'){markSurrendered(i,!seats[i].surrendered);return;}const voteFrom = parseInt(e.dataTransfer.getData('vote-card'),10);if(!isNaN(voteFrom)&& !seats[i].dead && !seats[i].suicide && !seats[voteFrom].dead && !seats[voteFrom].suicide){for(let j = 0;j < voteMap.length;j++){voteMap[j] = voteMap[j].filter(idx => idx !== voteFrom);}voteMap[i].push(voteFrom);saveState();renderSeats();renderVoteArea();}};seatDiv.ondragenter =(e)=>{e.preventDefault();};seatDiv.ondragleave =(e)=>{};const seatVotes = document.createElement('div');seatVotes.className = 'seat-votes';const votes =(voteMap[i] || []).slice().sort((a,b)=> a - b);for(const voterIdx of votes){const card = document.createElement('div');card.className = 'seat-vote-card';card.setAttribute('draggable','true');card.setAttribute('data-voter',voterIdx);card.setAttribute('data-target',i);card.textContent = voterIdx + 1;card.ondragstart = function(e){e.dataTransfer.setData('vote-card',voterIdx);setTimeout(()=> card.classList.add('dragging'),0);};card.ondragend = function(){card.classList.remove('dragging');};seatVotes.appendChild(card);}seatDiv.appendChild(seatVotes);}document.getElementById('seatCount').textContent = `座位数：${n}`;if(typeof initRoleTooltip === 'function'){initRoleTooltip();}}function addSeat(){if(seats.length < maxSeats){seats.push({name:"",dead:false,out:false,suicide:false,flipped:false,surrendered:false});voteMap.push([]);renderSeats();renderVoteArea();saveState();}}function removeSeat(){if(seats.length > minSeats){seats.pop();voteMap.pop();for(let i = 0;i < voteMap.length;i++){voteMap[i] = voteMap[i].filter(idx => idx < seats.length);}renderSeats();renderVoteArea();saveState();}}function updateName(index,value){seats[index].name = value;updatePhaseDisplay();if(typeof onSeatNameChanged === 'function'){onSeatNameChanged();}saveState();}function selectName(index,value){seats[index].name = value;renderSeats();renderVoteArea();updatePhaseDisplay();if(typeof onSeatNameChanged === 'function'){onSeatNameChanged();}saveState();}function clearName(index){seats[index].name = "";renderSeats();renderVoteArea();updatePhaseDisplay();saveState();}function markDead(index,dead){const wasAlive = !seats[index].dead;seats[index].dead = dead;if(dead){if(wasAlive){addHistoryRecord(index,'death');}for(let i = 0;i < voteMap.length;i++){voteMap[i] = voteMap[i].filter(idx => idx !== index);}voteMap[index] = [];}renderSeats();renderVoteArea();updatePhaseDisplay();saveState();}function markOut(index,out){const wasIn = !seats[index].out;seats[index].out = out;if(out){if(wasIn){addHistoryRecord(index,'out');}for(let i = 0;i < voteMap.length;i++){voteMap[i] = voteMap[i].filter(idx => idx !== index);}voteMap[index] = [];}renderSeats();renderVoteArea();updatePhaseDisplay();saveState();}function markFlipped(index,flipped){const wasNotFlipped = !seats[index].flipped;seats[index].flipped = flipped;if(flipped){if(wasNotFlipped){addHistoryRecord(index,'flip');}}renderSeats();renderVoteArea();saveState();}function markSurrendered(index,surrendered){const wasNotSurrendered = !seats[index].surrendered;seats[index].surrendered = surrendered;if(surrendered){if(wasNotSurrendered){addHistoryRecord(index,'surrender');}}renderSeats();renderVoteArea();saveState();}function markSuicide(index,suicide){const wasAlive = !seats[index].suicide;seats[index].suicide = suicide;if(suicide){if(wasAlive){addHistoryRecord(index,'suicide');}for(let i = 0;i < voteMap.length;i++){voteMap[i] = voteMap[i].filter(idx => idx !== index);}voteMap[index] = [];}renderSeats();renderVoteArea();updatePhaseDisplay();saveState();}function selectSingleSeat(seatIndex){selectedSeats = [seatIndex];renderSeats();}function toggleSeatSelection(seatIndex){const index = selectedSeats.indexOf(seatIndex);if(index > -1){selectedSeats.splice(index,1);}else{selectedSeats.push(seatIndex);}renderSeats();}function clearSeatSelection(){selectedSeats = [];renderSeats();}function toggleRoleCounters(seatIndex){document.querySelectorAll('.role-counter-buttons').forEach(panel =>{if(panel.id !== `roleCounters-${seatIndex}`){panel.classList.remove('show');}});const panel = document.getElementById(`roleCounters-${seatIndex}`);if(panel){panel.classList.toggle('show');}}function onSeatDeathDragStart(event,seatIndex){event.dataTransfer.setData('seat-death',seatIndex);}function onSeatOutDragStart(event,seatIndex){event.dataTransfer.setData('seat-out',seatIndex);}function onSeatSuicideDragStart(event,seatIndex){event.dataTransfer.setData('seat-suicide',seatIndex);}function onSeatFlipDragStart(event,seatIndex){event.dataTransfer.setData('seat-flip',seatIndex);}function onSeatSurrenderDragStart(event,seatIndex){event.dataTransfer.setData('seat-surrender',seatIndex);}function handleSelectedSeatsSkill(){if(selectedSeats.length === 0)return;showSkillDialog();}function handleNameEditKeyDown(event,seatIndex){}function handleNameEditKeyUp(event,seatIndex){}function initGlobalKeyEvents(){document.addEventListener('keydown',function(event){if(event.key === 'Enter'){if(event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA'){return;}if(selectedSeats.length > 0){event.preventDefault();handleSelectedSeatsSkill();}}});}function showSkillDialog(){document.getElementById('skillDialog').style.display = 'flex';const input = document.getElementById('skillDialogInput');input.value = '';setTimeout(()=> input.focus(),100);}function closeSkillDialog(){document.getElementById('skillDialog').style.display = 'none';}function setSkillPreset(presetText){const input = document.getElementById('skillDialogInput');input.value = presetText;input.focus();}function confirmSkill(){if(selectedSeats.length === 0){closeSkillDialog();return;}const skillDetail = document.getElementById('skillDialogInput').value.trim();addSkillHistoryRecord(selectedSeats,skillDetail);clearSeatSelection();closeSkillDialog();}function renderVoteArea(){const voteArea = document.getElementById('voteArea');voteArea.innerHTML = '';let cardCount = 0;for(let i = 0;i < seats.length;i++){if(seats[i].dead || seats[i].out || seats[i].suicide)continue;let used = false;for(let j = 0;j < voteMap.length;j++){if(voteMap[j].includes(i))used = true;}if(!used){const card = document.createElement('div');card.className = 'vote-card';card.setAttribute('draggable','true');card.setAttribute('data-voter',i);card.textContent = i + 1;card.ondragstart = function(e){e.dataTransfer.setData('vote-card',i);setTimeout(()=> card.classList.add('dragging'),0);};card.ondragend = function(){card.classList.remove('dragging');};voteArea.appendChild(card);cardCount++;}}voteArea.style.width = "auto";voteArea.style.minWidth = "100%";voteArea.style.maxWidth = "100%";voteArea.style.overflowX = "auto";}function copyVotes(){let lines = [];for(let i = 0;i < voteMap.length;i++){if(voteMap[i].length > 0){const voters = voteMap[i].slice().sort((a,b)=> a - b).map(idx =>(idx + 1)).join(' ');lines.push(`${voters}→${i + 1}`);}}let allVoters = new Set();for(let i = 0;i < voteMap.length;i++){for(const voter of voteMap[i]){allVoters.add(voter);}}let unvoted = [];for(let i = 0;i < seats.length;i++){if(seats[i].dead || seats[i].out || seats[i].suicide)continue;let used = false;for(let j = 0;j < voteMap.length;j++){if(voteMap[j].includes(i))used = true;}if(!used){unvoted.push(i + 1);}}if(unvoted.length > 0){lines.push(`${unvoted.join(' ')}→弃票`);}const text = lines.join('\n');if(text){addVoteHistoryRecord(text);copyToClipboard(text,'票型已复制到剪贴板');}else{alert('当前没有投票数据');}}function copyToClipboard(text,successMsg = '已复制到剪贴板'){if(navigator.clipboard){navigator.clipboard.writeText(text).then(()=>{showToast(successMsg);},()=>{showToast('复制失败，请手动复制','error');});}else{const textarea = document.createElement('textarea');textarea.value = text;document.body.appendChild(textarea);textarea.select();try{document.execCommand('copy');showToast(successMsg);}catch{showToast('复制失败，请手动复制','error');}document.body.removeChild(textarea);}}function showToast(message,type = 'success'){const toast = document.createElement('div');toast.textContent = message;toast.style.cssText = ` position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:${type === 'error' ? 'rgba(231,76,60,0.9)':'rgba(46,204,113,0.9)'};color:white;padding:12px 24px;border-radius:6px;font-size:14px;font-weight:500;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.3);animation:toastFadeIn 0.3s ease-out;pointer-events:none;`;if(!document.getElementById('toast-styles')){const style = document.createElement('style');style.id = 'toast-styles';style.textContent = ` @keyframes toastFadeIn{from{opacity:0;transform:translate(-50%,-50%)scale(0.8);}to{opacity:1;transform:translate(-50%,-50%)scale(1);}}@keyframes toastFadeOut{from{opacity:1;transform:translate(-50%,-50%)scale(1);}to{opacity:0;transform:translate(-50%,-50%)scale(0.8);}}`;document.head.appendChild(style);}document.body.appendChild(toast);setTimeout(()=>{toast.style.animation = 'toastFadeOut 0.3s ease-in forwards';setTimeout(()=>{if(toast.parentNode){toast.parentNode.removeChild(toast);}},300);},2000);}function onVoteAreaDrop(e){e.preventDefault();const voterIdx = parseInt(e.dataTransfer.getData('vote-card'),10);if(!isNaN(voterIdx)){for(let i = 0;i < voteMap.length;i++){voteMap[i] = voteMap[i].filter(idx => idx !== voterIdx);}saveState();renderSeats();renderVoteArea();}}function resetVotes(){voteMap = [];for(let i = 0;i < seats.length;i++)voteMap.push([]);renderSeats();renderVoteArea();saveState();}function addHistoryRecord(seatIndex,action){const seatNumber = seatIndex + 1;const characterName = seats[seatIndex].name.trim()|| '未知身份';let actionText;switch(action){case 'death':actionText = '被杀死';break;case 'out':actionText = '被票出';break;case 'suicide':actionText = '自爆';break;case 'flip':actionText = '翻牌';break;case 'surrender':actionText = '叛变';break;default:actionText = '状态变更';}const record ={timestamp:new Date().toLocaleTimeString(),seatNumber:seatNumber,characterName:characterName,action:action,actionText:actionText,type:'status'};history.push(record);renderHistory();saveState();}function addCounterHistoryRecord(delta,oldValue,newValue,seatIndex = null){let operatorSeat = seatIndex;if(operatorSeat === null){let maxVotes = 0;for(let i = 0;i < seats.length;i++){const votes =(voteMap[i] || []).length;if(!seats[i].dead && !seats[i].out && !seats[i].suicide && votes > maxVotes){maxVotes = votes;operatorSeat = i;}}if(operatorSeat === null)return;}const seatNumber = operatorSeat + 1;const characterName = seats[operatorSeat].name.trim()|| '未知身份';const record ={timestamp:new Date().toLocaleTimeString(),seatNumber:seatNumber,characterName:characterName,action:delta < 0 ? 'counter_decrease':'counter_increase',actionText:delta < 0 ? `发动技能 ${delta}=${newValue}`:`屯田 +${delta}=${newValue}`,economicChange:delta,remaining:newValue,type:'counter'};history.push(record);renderHistory();saveState();}function addSkillHistoryRecord(selectedSeatIndexes,skillDetail = ''){if(selectedSeatIndexes.length === 0)return;let skillText = '';let seatNumbers = [];let characterNames = [];if(selectedSeatIndexes.length === 1){const seatIndex = selectedSeatIndexes[0];const seatNumber = seatIndex + 1;const characterName = seats[seatIndex].name.trim()|| '未知身份';skillText = `<span class="seat-number">${seatNumber}</span><span class="character-name">${characterName}</span><span class="action">发动技能</span>`;}else{const firstSeatIndex = selectedSeatIndexes[0];const firstSeatNumber = firstSeatIndex + 1;const firstCharacterName = seats[firstSeatIndex].name.trim()|| '未知身份';const targets = selectedSeatIndexes.slice(1).map(index =>{const seatNumber = index + 1;const characterName = seats[index].name.trim()|| '未知身份';return `<span class="seat-number">${seatNumber}</span><span class="character-name">${characterName}</span>`;}).join('');skillText = `<span class="seat-number">${firstSeatNumber}</span><span class="character-name">${firstCharacterName}</span>对${targets}<span class="action">发动技能</span>`;}const record ={timestamp:new Date().toLocaleTimeString(),action:'skill',actionText:skillText,skillDetail:skillDetail || '',type:'skill'};history.push(record);renderHistory();saveState();}function addEconomyHistoryRecord(economyValue){const record ={timestamp:new Date().toLocaleTimeString(),action:'economy',actionText:'经济',economyValue:economyValue,type:'economy'};history.push(record);renderHistory();saveState();}function addVoteHistoryRecord(voteText){const record ={timestamp:new Date().toLocaleTimeString(),action:'vote_summary',actionText:'投票',voteContent:voteText,type:'vote'};history.push(record);renderHistory();saveState();}function addDayHistoryRecord(currentDay){const alivePlayers = [];for(let i = 0;i < seats.length;i++){if(!seats[i].dead && !seats[i].out && !seats[i].suicide){const seatNumber = i + 1;const characterName = seats[i].name.trim()|| '未知身份';alivePlayers.push(`${seatNumber}${characterName}`);}}const record ={timestamp:new Date().toLocaleTimeString(),action:'day_start',actionText:`第${currentDay}天`,dayCount:currentDay,economyValue:counter,alivePlayers:alivePlayers,type:'day'};history.push(record);renderHistory();saveState();}function addSeatPickHistoryRecord(seatNumber){const record ={timestamp:new Date().toLocaleTimeString(),seatNumber:seatNumber,type:'seat_pick',actionText:`抽取到 ${seatNumber}号`};history.push(record);renderHistory();saveState();}function copyHistoryRecord(index){if(index < 0 || index >= history.length)return;const record = history[index];let copyText = '';if(record.type === 'counter'){copyText = `${record.seatNumber}号${record.actionText}`;}else if(record.type === 'vote'){copyText = `${record.actionText}\n${record.voteContent}`;}else if(record.type === 'economy'){copyText = `${record.actionText}${record.economyValue}`;}else if(record.type === 'skill'){let skillText = record.actionText.replace(/<[^>]*>/g,'').replace(/[^\d号对发动技能]/g,match =>{return ['号','对','发','动','技','能'].includes(match)? match:'';});const seatNumbers = record.actionText.match(/\d+/g)|| [];if(seatNumbers.length === 1){skillText = `${seatNumbers[0]}号发动技能`;}else if(seatNumbers.length > 1){const [first,...targets] = seatNumbers;skillText = `${first}号对${targets.join('号、')}号发动技能`;}if(record.skillDetail){skillText += ' ' + record.skillDetail;}copyText = skillText;}else if(record.type === 'seat_pick'){copyText = record.actionText;}else if(record.type === 'day'){const aliveSeats = record.alivePlayers ? record.alivePlayers.map(player =>{const match = player.match(/^(\d+)/);return match ? match[1]:'';}).filter(seat => seat).join(' '):'';let economyInfo = record.economyValue !== undefined ? record.economyValue.toString():'';const hasHaoJing = seats.some(seat => !seat.dead && !seat.out && !seat.suicide && seat.name && seat.name.includes('郝经'));if(hasHaoJing && economyInfo && record.dayCount === 1){const shouldObfuscate = confirm('郝经存活，是否模糊经济点？');if(shouldObfuscate){if(economyInfo.length === 1){economyInfo = '?' + economyInfo;}else{economyInfo = '?' + economyInfo.substring(1);}}}copyText = `${record.actionText}\n经济：${economyInfo}\n存活：${aliveSeats}`;}else{copyText = `${record.seatNumber}号${record.actionText}`;}copyToClipboard(copyText,'记录已复制到剪贴板（不含身份）');}function renderHistory(){const historyContent = document.getElementById('historyContent');if(history.length === 0){historyContent.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">暂无记录</div>';return;}historyContent.innerHTML = history.map((record,index)=>{if(record.type === 'counter'){const isDecrease = record.economicChange < 0;const cssClass = isDecrease ? 'economy_loss':'economy_gain';const economyValueColor = record.remaining < 10 ? 'color:#ff4444;':'';const actionTextParts = record.actionText.split('=');const baseText = actionTextParts[0] + '=';const economyValue = actionTextParts[1] || '';return ` <div class="history-item ${cssClass}"> <span class="seat-number">${record.seatNumber}</span><span class="character-name">${record.characterName}</span><span class="action">${baseText}<span style="${economyValueColor}">${economyValue}</span></span> <div style="font-size:12px;color:#aaa;margin-top:2px;">${record.timestamp}</div> <button class="copy-btn" onclick="copyHistoryRecord(${index})" title="复制此记录">📋</button> <button class="delete-btn" onclick="deleteHistoryRecord(${index})" title="删除此记录">×</button> </div> `;}else if(record.type === 'vote'){return ` <div class="history-item vote_summary"> <span class="action">${record.actionText}</span> <div style="font-size:13px;color:#ccc;margin-top:4px;line-height:1.3;white-space:pre-line;">${record.voteContent}</div> <div style="font-size:12px;color:#aaa;margin-top:2px;">${record.timestamp}</div> <button class="copy-btn" onclick="copyHistoryRecord(${index})" title="复制此记录">📋</button> <button class="delete-btn" onclick="deleteHistoryRecord(${index})" title="删除此记录">×</button> </div> `;}else if(record.type === 'economy'){const economyValueColor = record.economyValue < 10 ? 'color:#ff4444;':'color:#fff;';return ` <div class="history-item economy"> <span class="action" style="color:#fff;">${record.actionText}<span style="${economyValueColor}">${record.economyValue}</span></span> <div style="font-size:12px;color:#aaa;margin-top:2px;">${record.timestamp}</div> <button class="copy-btn" onclick="copyHistoryRecord(${index})" title="复制此记录">📋</button> <button class="delete-btn" onclick="deleteHistoryRecord(${index})" title="删除此记录">×</button> </div> `;}else if(record.type === 'day'){const economyValueColor = record.economyValue < 10 ? 'color:#ff4444;':'color:#fff;';return ` <div class="history-item day_start"> <span class="action" style="color:#4fc3f7;font-weight:bold;">${record.actionText}</span> <div style="font-size:13px;margin-top:4px;"> <span style="color:#fff;">经济：</span><span style="${economyValueColor}">${record.economyValue}</span> | <span style="color:#fff;">存活：${record.alivePlayers.join('、')}</span> </div> <div style="font-size:12px;color:#aaa;margin-top:2px;">${record.timestamp}</div> <button class="copy-btn" onclick="copyHistoryRecord(${index})" title="复制此记录">📋</button> <button class="delete-btn" onclick="deleteHistoryRecord(${index})" title="删除此记录">×</button> </div> `;}else if(record.type === 'skill'){let skillDetailDisplay = '';if(record.skillDetail){skillDetailDisplay = `<div style="font-size:13px;color:#fff;margin-top:4px;background:rgba(52,152,219,0.3);padding:4px 8px;border-radius:4px;">${record.skillDetail}</div>`;}return ` <div class="history-item skill"> <span class="action">${record.actionText}</span> ${skillDetailDisplay}<div style="font-size:12px;color:#aaa;margin-top:2px;">${record.timestamp}</div> <button class="copy-btn" onclick="copyHistoryRecord(${index})" title="复制此记录">📋</button> <button class="delete-btn" onclick="deleteHistoryRecord(${index})" title="删除此记录">×</button> </div> `;}else if(record.type === 'seat_pick'){return ` <div class="history-item seat_pick" style="border-left-color:#9b59b6;"> <span class="action">${record.actionText}</span> <div style="font-size:12px;color:#aaa;margin-top:2px;">${record.timestamp}</div> <button class="copy-btn" onclick="copyHistoryRecord(${index})" title="复制此记录">📋</button> <button class="delete-btn" onclick="deleteHistoryRecord(${index})" title="删除此记录">×</button> </div> `;}else{return ` <div class="history-item ${record.action}"> <span class="seat-number">${record.seatNumber}</span><span class="character-name">${record.characterName}</span><span class="action">${record.actionText}</span> <div style="font-size:12px;color:#aaa;margin-top:2px;">${record.timestamp}</div> <button class="copy-btn" onclick="copyHistoryRecord(${index})" title="复制此记录">📋</button> <button class="delete-btn" onclick="deleteHistoryRecord(${index})" title="删除此记录">×</button> </div> `;}}).join('');setTimeout(()=>{historyContent.scrollTop = historyContent.scrollHeight;},0);}function clearHistory(){if(confirm('确定要清空历史记录吗？')){history = [];renderHistory();saveState();}}function deleteHistoryRecord(index){if(index >= 0 && index < history.length){history.splice(index,1);renderHistory();saveState();}}function exportHistory(){if(history.length === 0){alert('没有历史记录可以导出');return;}const exportText = history.map(record =>{if(record.type === 'counter'){return `${record.seatNumber}${record.characterName}${record.actionText}`;}else if(record.type === 'vote'){return `${record.actionText}\n${record.voteContent}`;}else if(record.type === 'economy'){return `${record.actionText}${record.economyValue}`;}else if(record.type === 'skill'){let skillText = record.actionText.replace(/<[^>]*>/g,'');if(record.skillDetail){skillText += ' ' + record.skillDetail;}return skillText;}else if(record.type === 'seat_pick'){return record.actionText;}else if(record.type === 'day'){const aliveInfo = record.alivePlayers ? record.alivePlayers.map(player =>{const match = player.match(/^(\d+)/);return match ? match[1]:'';}).filter(seat => seat).join(' '):'';const economyInfo = record.economyValue !== undefined ? record.economyValue:'';return `${record.actionText}\n经济：${economyInfo}\n存活：${aliveInfo}`;}else{return `${record.seatNumber}${record.characterName}${record.actionText}`;}}).join('\n');copyToClipboard(exportText,'历史记录已复制到剪贴板');}function updatePhaseDisplay(){const phaseTimeEl = document.getElementById('phaseTime');const phaseDayEl = document.getElementById('phaseDay');const phaseSettlementEl = document.getElementById('phaseSettlement');const prevBtn = document.getElementById('prevPhaseBtn');const nextBtn = document.getElementById('nextPhaseBtn');phaseTimeEl.textContent = isDayTime ? '白天':'黑夜';phaseTimeEl.className = 'phase-time ' +(isDayTime ? 'day':'night');phaseDayEl.textContent = `第${dayCount}天`;if(isDayTime){if(dayCount === 0){phaseSettlementEl.innerHTML = '<span class="empty">无发言</span>';phaseSettlementEl.classList.add('empty');}else{phaseSettlementEl.innerHTML = dayCount % 2 === 1 ? '顺序发言':'倒序发言';}}else{const currentStepRoles = getCurrentStepRoles();if(currentStepRoles.length === 0){phaseSettlementEl.innerHTML = '<span class="empty">无结算角色</span>';phaseSettlementEl.classList.add('empty');}else{const roleTexts = currentStepRoles.map(role =>{const seatIndex = findSeatByRole(role.character);return `(${seatIndex + 1})${role.text}`;});phaseSettlementEl.innerHTML = roleTexts.join('<br>');phaseSettlementEl.classList.remove('empty');}}prevBtn.disabled =(isDayTime || currentPhaseStep <= 0);nextBtn.disabled =(isDayTime || currentPhaseStep >= settlementPriority.length - 1);}function getCurrentStepRoles(){if(isDayTime || currentPhaseStep < 0 || currentPhaseStep >= settlementPriority.length){return [];}const stepRoles = settlementPriority[currentPhaseStep];return stepRoles.filter(role =>{if(role.isFixedSettlement){return true;}const seatIndex = findSeatByRole(role.character);if(seatIndex === -1 || seats[seatIndex].dead || seats[seatIndex].out || seats[seatIndex].suicide){return false;}const nightRestriction = role.nightRestriction || "any";if(nightRestriction === "firstNight"){return dayCount === 0;}else if(nightRestriction === "notFirstNight"){return dayCount > 0;}else{return true;}});}function findSeatByRole(roleName){for(let i = 0;i < seats.length;i++){if(seats[i].name === roleName){return i;}}return -1;}function toggleDayNight(){isDayTime = !isDayTime;if(isDayTime){dayCount++;currentPhaseStep = 0;addDayHistoryRecord(dayCount);}else{findNextValidStep();}updatePhaseDisplay();saveState();}function changeDayCount(delta){const newDayCount = dayCount + delta;if(newDayCount < 0)return;dayCount = newDayCount;if(delta > 0){for(let i = 0;i < delta;i++){addDayHistoryRecord(dayCount - delta + i + 1);}}updatePhaseDisplay();saveState();}function prevPhaseStep(){if(isDayTime || currentPhaseStep <= 0)return;currentPhaseStep--;if(getCurrentStepRoles().length === 0 && currentPhaseStep > 0){prevPhaseStep();return;}updatePhaseDisplay();saveState();}function nextPhaseStep(){if(isDayTime || currentPhaseStep >= settlementPriority.length - 1)return;currentPhaseStep++;if(getCurrentStepRoles().length === 0 && currentPhaseStep < settlementPriority.length - 1){nextPhaseStep();return;}updatePhaseDisplay();saveState();}function findNextValidStep(){while(currentPhaseStep < settlementPriority.length){if(getCurrentStepRoles().length > 0){break;}currentPhaseStep++;}if(currentPhaseStep >= settlementPriority.length){currentPhaseStep = 0;}}function resetPhasePanelPosition(){const phasePanel = document.getElementById('phasePanel');phasePanel.style.right = '20px';phasePanel.style.top = '20px';phasePanel.style.left = 'auto';phasePanel.style.bottom = 'auto';localStorage.removeItem('phasePanelPosition');}function initPhasePanelDrag(){let isPhaseDragging = false;let phaseStartX,phaseStartY,phaseInitialX,phaseInitialY;const phasePanel = document.getElementById('phasePanel');const phaseHeader = phasePanel.querySelector('.phase-header');const savedPhasePosition = localStorage.getItem('phasePanelPosition');if(savedPhasePosition){try{const position = JSON.parse(savedPhasePosition);if(position.left !== undefined){phasePanel.style.left = position.left + 'px';phasePanel.style.top = position.top + 'px';phasePanel.style.right = 'auto';phasePanel.style.bottom = 'auto';}else{phasePanel.style.right = position.right + 'px';phasePanel.style.top = position.top + 'px';phasePanel.style.left = 'auto';phasePanel.style.bottom = 'auto';}}catch(e){resetPhasePanelPosition();}}else{resetPhasePanelPosition();}phaseHeader.addEventListener('mousedown',function(e){isPhaseDragging = true;phaseStartX = e.clientX;phaseStartY = e.clientY;const rect = phasePanel.getBoundingClientRect();phaseInitialX = rect.left;phaseInitialY = rect.top;phasePanel.classList.add('dragging');e.preventDefault();});document.addEventListener('mousemove',function(e){if(isPhaseDragging){e.preventDefault();const dx = e.clientX - phaseStartX;const dy = e.clientY - phaseStartY;const newX = Math.max(0,Math.min(window.innerWidth - 280,phaseInitialX + dx));const newY = Math.max(0,Math.min(window.innerHeight - 150,phaseInitialY + dy));phasePanel.style.left = newX + 'px';phasePanel.style.top = newY + 'px';phasePanel.style.right = 'auto';phasePanel.style.bottom = 'auto';}});document.addEventListener('mouseup',function(){if(isPhaseDragging){isPhaseDragging = false;phasePanel.classList.remove('dragging');const rect = phasePanel.getBoundingClientRect();const position ={left:rect.left,top:rect.top};localStorage.setItem('phasePanelPosition',JSON.stringify(position));}});}function pickRandomSeat(){const availableSeats = [];for(let i = 0;i < seats.length;i++){if(!seats[i].dead && !seats[i].out && !seats[i].suicide){availableSeats.push(i);}}const resultDiv = document.getElementById('seatPickerResult');if(availableSeats.length === 0){resultDiv.textContent = '无可用座位';resultDiv.className = 'seat-picker-result';return;}const randomIndex = Math.floor(Math.random()* availableSeats.length);const pickedSeatIndex = availableSeats[randomIndex];resultDiv.textContent = `${pickedSeatIndex + 1}号`;resultDiv.className = 'seat-picker-result highlight';addSeatPickHistoryRecord(pickedSeatIndex + 1);setTimeout(()=>{resultDiv.className = 'seat-picker-result';},3000);}function resetSeatPickerPosition(){const seatPicker = document.getElementById('seatPicker');seatPicker.style.right = '320px';seatPicker.style.top = '20px';seatPicker.style.left = 'auto';seatPicker.style.bottom = 'auto';seatPicker.style.transform = 'none';localStorage.removeItem('seatPickerPosition');}function initSeatPickerDrag(){let isPickerDragging = false;let pickerStartX,pickerStartY,pickerInitialX,pickerInitialY;const pickerPanel = document.getElementById('seatPicker');const pickerHeader = pickerPanel.querySelector('.seat-picker-header');const savedPickerPosition = localStorage.getItem('seatPickerPosition');if(savedPickerPosition){try{const position = JSON.parse(savedPickerPosition);if(position.left !== undefined){pickerPanel.style.left = position.left + 'px';pickerPanel.style.top = position.top + 'px';pickerPanel.style.right = 'auto';pickerPanel.style.bottom = 'auto';pickerPanel.style.transform = 'none';}else{pickerPanel.style.right = position.right + 'px';pickerPanel.style.bottom = position.bottom + 'px';pickerPanel.style.left = 'auto';pickerPanel.style.top = 'auto';pickerPanel.style.transform = 'none';}}catch(e){resetSeatPickerPosition();}}else{resetSeatPickerPosition();}pickerHeader.addEventListener('mousedown',function(e){isPickerDragging = true;pickerStartX = e.clientX;pickerStartY = e.clientY;const rect = pickerPanel.getBoundingClientRect();pickerInitialX = rect.left;pickerInitialY = rect.top;pickerPanel.classList.add('dragging');e.preventDefault();});document.addEventListener('mousemove',function(e){if(isPickerDragging){e.preventDefault();const dx = e.clientX - pickerStartX;const dy = e.clientY - pickerStartY;const newX = Math.max(0,Math.min(window.innerWidth - 200,pickerInitialX + dx));const newY = Math.max(0,Math.min(window.innerHeight - 150,pickerInitialY + dy));pickerPanel.style.left = newX + 'px';pickerPanel.style.top = newY + 'px';pickerPanel.style.right = 'auto';pickerPanel.style.bottom = 'auto';pickerPanel.style.transform = 'none';}});document.addEventListener('mouseup',function(){if(isPickerDragging){isPickerDragging = false;pickerPanel.classList.remove('dragging');const rect = pickerPanel.getBoundingClientRect();const position ={left:rect.left,top:rect.top};localStorage.setItem('seatPickerPosition',JSON.stringify(position));}});}function saveState(){localStorage.setItem('seats',JSON.stringify(seats));localStorage.setItem('counter',counter);localStorage.setItem('voteMap',JSON.stringify(voteMap));localStorage.setItem('history',JSON.stringify(history));localStorage.setItem('isDayTime',isDayTime);localStorage.setItem('currentPhaseStep',currentPhaseStep);localStorage.setItem('dayCount',dayCount);}function loadState(){const seatsStr = localStorage.getItem('seats');const counterStr = localStorage.getItem('counter');const voteMapStr = localStorage.getItem('voteMap');const historyStr = localStorage.getItem('history');const isDayTimeStr = localStorage.getItem('isDayTime');const currentPhaseStepStr = localStorage.getItem('currentPhaseStep');const dayCountStr = localStorage.getItem('dayCount');if(seatsStr){try{seats = JSON.parse(seatsStr);for(let i = 0;i < seats.length;i++){if(seats[i].out === undefined){seats[i].out = false;}if(seats[i].suicide === undefined){seats[i].suicide = false;}if(seats[i].flipped === undefined){seats[i].flipped = false;}if(seats[i].surrendered === undefined){seats[i].surrendered = false;}}}catch{seats = [];}}if(counterStr !== null){counter = parseInt(counterStr,10)|| 20;}if(voteMapStr){try{voteMap = JSON.parse(voteMapStr);}catch{voteMap = [];}}if(historyStr){try{history = JSON.parse(historyStr);}catch{history = [];}}if(isDayTimeStr !== null){isDayTime = isDayTimeStr === 'true';}if(currentPhaseStepStr !== null){currentPhaseStep = parseInt(currentPhaseStepStr,10)|| 0;}if(dayCountStr !== null){dayCount = parseInt(dayCountStr,10)|| 0;}}function resetAll(){if(confirm('确定要重写《心史》吗？')){const keepNames = false;let savedNames = [];if(keepNames){savedNames = seats.map(seat => seat.name);}localStorage.removeItem('seats');localStorage.removeItem('counter');localStorage.removeItem('voteMap');localStorage.removeItem('history');localStorage.removeItem('isDayTime');localStorage.removeItem('currentPhaseStep');localStorage.removeItem('dayCount');initSeats(12);if(keepNames && savedNames.length > 0){for(let i = 0;i < Math.min(seats.length,savedNames.length);i++){seats[i].name = savedNames[i];}}counter = 20;history = [];isDayTime = true;currentPhaseStep = 0;dayCount = 0;renderSeats();renderVoteArea();renderHistory();updateCounterDisplay();updatePhaseDisplay();resetHistoryPanelPosition();resetSeatPickerPosition();resetPhasePanelPosition();resetRoleInfoPanelPosition();if(timerManager){timerManager.resetTimerPosition();timerManager.reset();}}}function initDragHandlers(){const markers = [{id:'deathMarker',type:'death'},{id:'outMarker',type:'out'},{id:'flipMarker',type:'flip'},{id:'surrenderMarker',type:'surrender'},{id:'suicideMarker',type:'suicide'}];markers.forEach(marker =>{document.getElementById(marker.id).addEventListener('dragstart',function(e){e.dataTransfer.setData('text/plain',marker.type);});});document.body.addEventListener('dragover',function(e){e.preventDefault();});document.body.addEventListener('drop',function(e){const isSeat = e.target.closest && e.target.closest('.seat');const voterIdx = parseInt(e.dataTransfer.getData('vote-card'),10);const seatDeathIdx = e.dataTransfer.getData('seat-death');if(!isSeat && seatDeathIdx !== ""){markDead(Number(seatDeathIdx),false);saveState();renderSeats();renderVoteArea();return;}const seatOutIdx = e.dataTransfer.getData('seat-out');if(!isSeat && seatOutIdx !== ""){markOut(Number(seatOutIdx),false);saveState();renderSeats();renderVoteArea();return;}const seatSuicideIdx = e.dataTransfer.getData('seat-suicide');if(!isSeat && seatSuicideIdx !== ""){markSuicide(Number(seatSuicideIdx),false);saveState();renderSeats();renderVoteArea();return;}const seatFlipIdx = e.dataTransfer.getData('seat-flip');if(!isSeat && seatFlipIdx !== ""){markFlipped(Number(seatFlipIdx),false);saveState();renderSeats();renderVoteArea();return;}const seatSurrenderIdx = e.dataTransfer.getData('seat-surrender');if(!isSeat && seatSurrenderIdx !== ""){markSurrendered(Number(seatSurrenderIdx),false);saveState();renderSeats();renderVoteArea();return;}if(isSeat && seatDeathIdx !== "" && Number(seatDeathIdx)!== Number(isSeat.getAttribute('data-index'))){markDead(Number(seatDeathIdx),false);markDead(Number(isSeat.getAttribute('data-index')),true);saveState();renderSeats();renderVoteArea();return;}if(isSeat && seatOutIdx !== "" && Number(seatOutIdx)!== Number(isSeat.getAttribute('data-index'))){markOut(Number(seatOutIdx),false);markOut(Number(isSeat.getAttribute('data-index')),true);saveState();renderSeats();renderVoteArea();return;}if(isSeat && seatSuicideIdx !== "" && Number(seatSuicideIdx)!== Number(isSeat.getAttribute('data-index'))){markSuicide(Number(seatSuicideIdx),false);markSuicide(Number(isSeat.getAttribute('data-index')),true);saveState();renderSeats();renderVoteArea();return;}if(isSeat && seatFlipIdx !== "" && Number(seatFlipIdx)!== Number(isSeat.getAttribute('data-index'))){markFlipped(Number(seatFlipIdx),false);markFlipped(Number(isSeat.getAttribute('data-index')),true);saveState();renderSeats();renderVoteArea();return;}if(isSeat && seatSurrenderIdx !== "" && Number(seatSurrenderIdx)!== Number(isSeat.getAttribute('data-index'))){markSurrendered(Number(seatSurrenderIdx),false);markSurrendered(Number(isSeat.getAttribute('data-index')),true);saveState();renderSeats();renderVoteArea();return;}if(!isSeat && !isNaN(voterIdx)){for(let i = 0;i < voteMap.length;i++){voteMap[i] = voteMap[i].filter(idx => idx !== voterIdx);}saveState();renderSeats();renderVoteArea();}});}let isDragging = false;let isResizing = false;let dragOffset ={x:0,y:0};let resizeStartPos ={x:0,y:0};let resizeStartSize ={width:0,height:0};const defaultPosition ={left:20,bottom:20};const defaultSize ={width:360,height:240};function initHistoryPanelDrag(){const historyPanel = document.getElementById('historyPanel');const historyHeader = historyPanel.querySelector('.history-header');const resizeHandle = document.getElementById('historyResizeHandle');const savedPosition = localStorage.getItem('historyPanelPosition');const savedSize = localStorage.getItem('historyPanelSize');if(savedPosition){try{const position = JSON.parse(savedPosition);historyPanel.style.left = position.left + 'px';historyPanel.style.bottom = position.bottom + 'px';}catch(e){resetHistoryPanelPosition();}}if(savedSize){try{const size = JSON.parse(savedSize);historyPanel.style.width = size.width + 'px';historyPanel.style.maxHeight = size.height + 'px';}catch(e){resetHistoryPanelSize();}}else{resetHistoryPanelSize();}historyHeader.addEventListener('mousedown',function(e){if(e.target === resizeHandle)return;isDragging = true;historyPanel.classList.add('dragging');const rect = historyPanel.getBoundingClientRect();dragOffset.x = e.clientX - rect.left;dragOffset.y = e.clientY - rect.top;e.preventDefault();});resizeHandle.addEventListener('mousedown',function(e){isResizing = true;resizeStartPos.x = e.clientX;resizeStartPos.y = e.clientY;const rect = historyPanel.getBoundingClientRect();resizeStartSize.width = rect.width;resizeStartSize.height = rect.height;historyPanel.classList.add('dragging');e.preventDefault();e.stopPropagation();});document.addEventListener('mousemove',function(e){if(isDragging && !isResizing){e.preventDefault();let newLeft = e.clientX - dragOffset.x;let newTop = e.clientY - dragOffset.y;const panelRect = historyPanel.getBoundingClientRect();const maxLeft = window.innerWidth - panelRect.width;const maxTop = window.innerHeight - panelRect.height;newLeft = Math.max(0,Math.min(newLeft,maxLeft));newTop = Math.max(0,Math.min(newTop,maxTop));historyPanel.style.left = newLeft + 'px';historyPanel.style.top = newTop + 'px';historyPanel.style.bottom = 'auto';}else if(isResizing){e.preventDefault();const deltaX = e.clientX - resizeStartPos.x;const deltaY = e.clientY - resizeStartPos.y;let newWidth = resizeStartSize.width + deltaX;let newHeight = resizeStartSize.height + deltaY;newWidth = Math.max(280,Math.min(newWidth,window.innerWidth - 40));newHeight = Math.max(200,Math.min(newHeight,window.innerHeight - 40));historyPanel.style.width = newWidth + 'px';historyPanel.style.maxHeight = newHeight + 'px';}});document.addEventListener('mouseup',function(){if(isDragging || isResizing){historyPanel.classList.remove('dragging');if(isDragging){const rect = historyPanel.getBoundingClientRect();const position ={left:rect.left,bottom:window.innerHeight - rect.bottom};localStorage.setItem('historyPanelPosition',JSON.stringify(position));}if(isResizing){const rect = historyPanel.getBoundingClientRect();const size ={width:rect.width,height:rect.height};localStorage.setItem('historyPanelSize',JSON.stringify(size));}isDragging = false;isResizing = false;}});}function resetHistoryPanelPosition(){const historyPanel = document.getElementById('historyPanel');historyPanel.style.left = defaultPosition.left + 'px';historyPanel.style.bottom = defaultPosition.bottom + 'px';historyPanel.style.top = 'auto';localStorage.removeItem('historyPanelPosition');}function resetHistoryPanelSize(){const historyPanel = document.getElementById('historyPanel');historyPanel.style.width = defaultSize.width + 'px';historyPanel.style.maxHeight = defaultSize.height + 'px';localStorage.removeItem('historyPanelSize');}function resetSeatPickerPosition(){const seatPicker = document.getElementById('seatPicker');seatPicker.style.right = '320px';seatPicker.style.top = '20px';seatPicker.style.left = 'auto';seatPicker.style.bottom = 'auto';seatPicker.style.transform = 'none';localStorage.removeItem('seatPickerPosition');}class RoleInfoPanelManager{constructor(){this.panel = null;this.currentSeatIndex = -1;this.initialized = false;this.isDragging = false;this.dragOffset ={x:0,y:0};}init(){if(this.initialized)return;console.log('初始化身份信息面板...');this.panel = document.createElement('div');this.panel.className = 'role-info-panel';this.panel.innerHTML = ` <div class="role-info-header"> <span>身份信息</span> </div> <div class="role-info-content"> <div class="role-info-empty">鼠标悬停在座位上查看身份信息</div> </div> `;document.body.appendChild(this.panel);this.loadSavedPosition();this.initDragFunctionality();console.log('身份信息面板已创建并添加到DOM');this.initialized = true;}loadSavedPosition(){const savedPosition = localStorage.getItem('roleInfoPanelPosition');if(savedPosition){try{const position = JSON.parse(savedPosition);if(position.left !== undefined){this.panel.style.left = position.left + 'px';this.panel.style.top = position.top + 'px';this.panel.style.right = 'auto';this.panel.style.bottom = 'auto';}else{this.panel.style.right = position.right + 'px';this.panel.style.top = position.top + 'px';this.panel.style.left = 'auto';this.panel.style.bottom = 'auto';}}catch(e){console.log('解析保存的身份信息面板位置失败，使用默认位置');}}}initDragFunctionality(){const header = this.panel.querySelector('.role-info-header');header.addEventListener('mousedown',(e)=>{this.isDragging = true;this.panel.classList.add('dragging');const rect = this.panel.getBoundingClientRect();this.dragOffset.x = e.clientX - rect.left;this.dragOffset.y = e.clientY - rect.top;document.addEventListener('mousemove',this.handleDragMove);document.addEventListener('mouseup',this.handleDragEnd);e.preventDefault();});}handleDragMove =(e)=>{if(!this.isDragging)return;const x = e.clientX - this.dragOffset.x;const y = e.clientY - this.dragOffset.y;const maxX = window.innerWidth - this.panel.offsetWidth;const maxY = window.innerHeight - this.panel.offsetHeight;const boundedX = Math.max(0,Math.min(x,maxX));const boundedY = Math.max(0,Math.min(y,maxY));this.panel.style.left = `${boundedX}px`;this.panel.style.top = `${boundedY}px`;this.panel.style.right = 'auto';};handleDragEnd =()=>{this.isDragging = false;this.panel.classList.remove('dragging');document.removeEventListener('mousemove',this.handleDragMove);document.removeEventListener('mouseup',this.handleDragEnd);this.savePosition();};savePosition(){const rect = this.panel.getBoundingClientRect();const position ={left:rect.left,top:rect.top};localStorage.setItem('roleInfoPanelPosition',JSON.stringify(position));}show(seatIndex){if(!this.initialized){this.init();}console.log(`显示身份信息 - 座位${seatIndex + 1}`);this.currentSeatIndex = seatIndex;if(!seats[seatIndex]){console.log('座位数据不存在');this.showEmpty();return;}const seatName = seats[seatIndex].name.trim();const content = this.panel.querySelector('.role-info-content');console.log(`座位名称:"${seatName}"`);this.panel.classList.remove('song','outsider','mongolia','third','unknown');if(seatName && charactersDict[seatName]){const roleInfo = charactersDict[seatName];content.innerHTML = ` <div class="role-info-name">${seatName}</div> <div class="role-info-faction">${roleInfo.faction}</div> <div class="role-info-seat">${seatIndex + 1}号位</div> `;console.log(`身份信息:${seatName}- ${roleInfo.faction}(${roleInfo.class})`);this.panel.classList.add(roleInfo.class);}else{const displayName = seatName || '空白';const displayInfo = seatName ? '未知身份':'空白座位';content.innerHTML = ` <div class="role-info-name">${displayName}</div> <div class="role-info-faction">${displayInfo}</div> <div class="role-info-seat">${seatIndex + 1}号位</div> `;this.panel.classList.add('unknown');console.log(`未知身份:${displayName}- ${displayInfo}`);}}showEmpty(){const content = this.panel.querySelector('.role-info-content');content.innerHTML = ` <div class="role-info-empty">鼠标悬停在座位上查看身份信息</div> `;this.panel.classList.remove('song','outsider','mongolia','third','unknown');this.currentSeatIndex = -1;}update(){if(this.currentSeatIndex >= 0){this.show(this.currentSeatIndex);}}}const roleInfoPanelManager = new RoleInfoPanelManager();function addRoleInfoListeners(){console.log('开始添加身份信息面板事件监听器...');const seats = document.querySelectorAll('.seat');console.log(`找到 ${seats.length}个座位元素`);seats.forEach((seat,index)=>{const seatIndex = seat.getAttribute('data-index');console.log(`为座位 ${seatIndex}添加事件监听器`);seat.removeEventListener('mouseenter',handleSeatMouseEnter);seat.removeEventListener('mouseleave',handleSeatMouseLeave);seat.addEventListener('mouseenter',handleSeatMouseEnter);seat.addEventListener('mouseleave',handleSeatMouseLeave);});console.log('身份信息面板事件监听器添加完成');}function handleSeatMouseEnter(event){const seatElement = event.currentTarget;const seatIndex = parseInt(seatElement.getAttribute('data-index'));console.log(`鼠标进入座位 ${seatIndex + 1}`);roleInfoPanelManager.show(seatIndex);}function handleSeatMouseLeave(event){console.log('鼠标离开座位，保持面板显示');}function resetRoleInfoPanelPosition(){if(roleInfoPanelManager.panel){roleInfoPanelManager.panel.style.right = '20px';roleInfoPanelManager.panel.style.top = '280px';roleInfoPanelManager.panel.style.left = 'auto';roleInfoPanelManager.panel.style.bottom = 'auto';localStorage.removeItem('roleInfoPanelPosition');}}function initRoleTooltip(){console.log('初始化身份信息面板...');if(!roleInfoPanelManager.initialized){roleInfoPanelManager.init();}setTimeout(()=>{addRoleInfoListeners();},100);}function onSeatNameChanged(){roleInfoPanelManager.update();}class VersionChecker{constructor(){this.currentVersion =(typeof APP_VERSION !== 'undefined' ? APP_VERSION:'1.0.0').replace(/^v/,'');this.githubRepo = 'Runwill/cyber-Xinshi';}removeNotificationWithAnimation(notification){if(!notification || !notification.parentElement)return;notification.classList.add('slide-out');setTimeout(()=>{if(notification.parentElement){notification.remove();}},300);}compareVersions(v1,v2){const parts1 = v1.split('.').map(n => parseInt(n));const parts2 = v2.split('.').map(n => parseInt(n));for(let i = 0;i < Math.max(parts1.length,parts2.length);i++){const part1 = parts1[i] || 0;const part2 = parts2[i] || 0;if(part1 < part2)return -1;if(part1 > part2)return 1;}return 0;}async fetchLatestVersion(){try{let response = await fetch(`https://api.github.com/repos/${this.githubRepo}/releases`,{headers:{'User-Agent':'Mozilla/5.0(Windows NT 10.0;Win64;x64)AppleWebKit/537.36(KHTML,like Gecko)Chrome/91.0.4472.124 Safari/537.36','Accept':'application/vnd.github.v3+json'}});if(response.status === 404 || !response.ok){console.warn('GitHub仓库还没有任何Release，请先在GitHub上创建Release');return{noReleases:true,repoUrl:`https://github.com/${this.githubRepo}`};}const releases = await response.json();if(!releases || releases.length === 0){return{noReleases:true,repoUrl:`https://github.com/${this.githubRepo}`};}const latestRelease = releases[0];return{version:latestRelease.tag_name.replace(/^v/,''),name:latestRelease.name,body:latestRelease.body,url:latestRelease.html_url,publishedAt:latestRelease.published_at,isPrerelease:latestRelease.prerelease};}catch(error){console.error('获取版本信息失败:',error);return null;}}async checkForUpdate(){const latestInfo = await this.fetchLatestVersion();if(!latestInfo){return null;}if(latestInfo.noReleases){return{noReleases:true,currentVersion:this.currentVersion,repoUrl:latestInfo.repoUrl};}const comparison = this.compareVersions(this.currentVersion,latestInfo.version);return{hasUpdate:comparison < 0,currentVersion:this.currentVersion,latestVersion:latestInfo.version,latestInfo:latestInfo,isUpToDate:comparison >= 0};}showUpdateNotification(updateInfo){if(!updateInfo)return;const notification = document.createElement('div');notification.className = 'version-notification';if(updateInfo.noReleases){notification.innerHTML = ` <div class="version-notification-content"> <div class="version-notification-header"> <span class="version-notification-title">📋 需要配置版本发布</span> <button class="version-notification-close" onclick="versionChecker.removeNotificationWithAnimation(this.parentElement.parentElement.parentElement)">×</button> </div> <div class="version-notification-body"> <p>当前版本:v${updateInfo.currentVersion}</p> <p>GitHub仓库还没有任何Release</p> <p class="version-setup-needed">请在GitHub上创建第一个Release以启用版本检查功能</p> <div class="version-notification-actions"> <a href="${updateInfo.repoUrl}/releases/new" target="_blank" class="version-btn version-btn-primary"> 创建Release </a> <button class="version-btn version-btn-secondary" onclick="versionChecker.removeNotificationWithAnimation(this.parentElement.parentElement.parentElement.parentElement)"> 稍后配置 </button> </div> </div> </div> `;}else{const versionTypeText = updateInfo.latestInfo.isPrerelease ? '(预发布版本)':'';notification.innerHTML = ` <div class="version-notification-content"> <div class="version-notification-header"> <span class="version-notification-title"> ${updateInfo.hasUpdate ? '🎉 发现新版本':'✅ 已是最新版本'}</span> <button class="version-notification-close" onclick="versionChecker.removeNotificationWithAnimation(this.parentElement.parentElement.parentElement)">×</button> </div> <div class="version-notification-body"> <p>当前版本:v${updateInfo.currentVersion}</p> <p>最新版本:v${updateInfo.latestVersion}${versionTypeText}</p> ${updateInfo.hasUpdate ? ` <p class="version-update-available">有新版本可用！${updateInfo.latestInfo.isPrerelease ? '<br><small style="color:#888;">注意：这是预发布版本，可能包含实验性功能</small>':''}</p> <div class="version-notification-actions"> <a href="${updateInfo.latestInfo.url}" target="_blank" class="version-btn version-btn-primary"> 查看更新 </a> <button class="version-btn version-btn-secondary" onclick="versionChecker.removeNotificationWithAnimation(this.parentElement.parentElement.parentElement.parentElement)"> 稍后提醒 </button> </div> `:` <p class="version-up-to-date">您使用的是最新版本${versionTypeText}</p> `}</div> </div> `;}document.body.appendChild(notification);if(!updateInfo.noReleases && !updateInfo.hasUpdate){setTimeout(()=>{this.removeNotificationWithAnimation(notification);},3000);}}async autoCheck(){try{const updateInfo = await this.checkForUpdate();if(updateInfo && updateInfo.hasUpdate){this.showUpdateNotification(updateInfo);}}catch(error){console.warn('自动检查更新失败:',error);}}async manualCheck(){const checkingNotification = document.createElement('div');checkingNotification.className = 'version-notification checking';checkingNotification.innerHTML = ` <div class="version-notification-content"> <div class="version-notification-body"> <p>🔄 正在检查更新...</p> </div> </div> `;document.body.appendChild(checkingNotification);const updateInfo = await this.checkForUpdate();checkingNotification.remove();if(updateInfo){this.showUpdateNotification(updateInfo);}else{const errorNotification = document.createElement('div');errorNotification.className = 'version-notification error';errorNotification.innerHTML = ` <div class="version-notification-content"> <div class="version-notification-header"> <span class="version-notification-title">❌ 检查更新失败</span> <button class="version-notification-close" onclick="versionChecker.removeNotificationWithAnimation(this.parentElement.parentElement.parentElement)">×</button> </div> <div class="version-notification-body"> <p>无法连接到GitHub，请检查网络连接</p> </div> </div> `;document.body.appendChild(errorNotification);setTimeout(()=>{this.removeNotificationWithAnimation(errorNotification);},3000);}}}const versionChecker = new VersionChecker();document.addEventListener('DOMContentLoaded',()=>{setTimeout(()=>{versionChecker.autoCheck();},2000);});class ChangelogManager{constructor(){this.changelog ={"v0.5.3.250726":{title:"v0.5.3.250726",date:"2024年7月26日",features:[ "新增功能，在工具设置中可选择渲染倒计时器" ]},"v0.5.2.250725":{title:"v0.5.2.250725",date:"2024年7月25日",features:[ "新增功能，如果郝经存活，复制第1天的结算信息时，询问是否模糊经济" ]},"v0.5.1.250724":{title:"v0.5.1.250724",date:"2024年7月24日",features:[ "修改阔端的屯田点操作按钮为-1~-6","新增功能，在流程标志窗中显示【发言顺/逆序】","修复天数消息导出错误的漏洞","新增功能，可以复制单条历史记录，复制时不包含玩家身份，用于播报","删除复制票型和复制历史记录的确认步骤，新增复制内容到剪贴板时的提示消息","新增功能，若经济低于10点，则经济点在历史记录中显示为红色","修复重置时流程标志窗和座位抽取器位置未重置的漏洞","修复座位抽取器的历史记录格式错误的漏洞","修复流程标志窗的位置信息未保存的漏洞","新增蒲寿庚的+5屯田点操作按钮，用于返还屯田点<br><span class='changelog-comment'>会显示蒲寿庚【屯田】，待解决</span>","新增流程标志窗中，正在结算的身份的效果说明，区分首夜、非首夜、任一夜晚的效果","模块化单网页项目，便于后续维护；添加构建项目为单一html文件的命令","修改选中座位逻辑，仅在松开Ctrl并单击座位后取消选中。Ctrl+左键选择座位时，即使点击名牌，也会选中座位","新增功能，页面打开后2s静默检查是否存在新版本，也可手动检查","新增身份信息框，鼠标经过座位时，更新显示内容为该座位身份的信息<br><span class='changelog-comment'>身份的详细效果介绍待添加</span>","整合部分按钮功能至工具面板，点击原【身份筛选】按钮位置的【工具设计】进入工具面板","新增页内查看更新公告的功能" ]},"v0.5.0.250708":{title:"v0.5.0.250708",date:"2024年7月8日",features:[ "新增结算流程的步骤提示框，每次进入白天时更新历史记录","新增座位抽取器，点击抽取存活的座位之一" ]},"v0.4.4.250706":{title:"v0.4.4.250706",date:"2024年7月6日",features:[ "修复屯田点变化历史记录文本与样式错误的漏洞","新增在座位名牌上按住Alt时，显示完整角色列表的功能" ]},"v0.4.3.250706":{title:"v0.4.3.250706",date:"2024年7月6日",features:[ "新增身份高稼、丁大全、赵彦呐（蜀阃）","修改被选中座位的颜色","修改输入框弹窗的样式","新增发动技能历史记录的备注功能，点击预设按钮添加预设文本，无备注输入则不输出备注","修改弹窗的确认快捷键为回车，输入框不可换行，移除确认与取消按钮（例：选中座位后直接按两次回车，输出无备注记录）","新增历史记录框的调节功能" ]},"v0.4.2.250702":{title:"v0.4.2.250702",date:"2024年7月2日",features:[ "新增经济点历史记录，在经济点框内按回车，添加历史并取消选中","修复初始化网页时屯田点为0的漏洞","删除删除历史记录时的确认步骤","新增发动技能历史记录。Ctrl+左键选中若干座位，按回车在历史记录中添加首选座位角色对剩余角色发动技能的历史","修改历史记录的文本颜色" ]},"v0.4.1.250701":{title:"v0.4.1.250701",date:"2024年7月1日",features:[ "修复票出角色的票牌未隐藏的漏洞","新增删除单条历史记录的功能","新增翻牌、叛变、自爆标记","修改标记图标，统一风格","修复出局座位的身份列表被在场座位遮挡的漏洞","新增身份吕文焕（荆阃）、阔端、耶律楚材" ]},"v0.4.0.250630":{title:"v0.4.0.250630",date:"2024年6月30日",features:[ "新增角色谢道清","修改屯田点操作按钮，绑定指定身份的座位。点击齿轮按钮展开屯田点修改按钮的列表，点击其他位置收起。文官屯田加成用阃帅座位的+8按钮表示","修改初始屯田点为20","新增身份筛选列表置底的【清空】选项，点击清空该座位的身份文本。在搜索无结果时不显示","新增历史记录功能。记录玩家被杀死/票出、屯田点变化，在复制票型时记录票型。在重置或点击【清空】按钮时清空。点击【导出】按钮复制所有历史记录到剪贴板。历史记录框可以被拖动，在重置时还原位置" ]},"v0.3.1.250622":{title:"v0.3.1.250622",date:"2024年6月22日",features:[ "新增身份（角色）列表筛选功能，输入以空格或换行分隔的角色关键词文本，重置时不清空，如果文本存在，角色列表仅显示包含至少一个角色关键词的角色名" ]},"v0.2.2.250620":{title:"v0.2.2.250620",date:"2024年6月20日",features:[ "修复角色旭烈兀未加入的漏洞" ]},"v0.2.1.250620":{title:"v0.2.1.250620",date:"2024年6月20日",features:[ "新增角色" ]},"v0.2.0.250602":{title:"v0.2.0.250602",date:"2024年6月2日",features:[ "本地存储数据，刷新或关闭页面不丢失记录，通过重置按钮还原初始状态","新增票牌，拖动票牌到座位上记录票型，拖出座位则放回票牌，点击按钮复制票型到剪贴板（死亡玩家的票不生成，玩家死亡时），高亮得票最多的座位，标记死亡的座位无法被上票","新增名牌输入时的筛选逻辑。设置名牌初始为空","允许被标记死亡的座位的名牌被编辑","新增票出标记","新增页脚链接到仓库" ]}};}getCurrentVersionChangelog(){const currentVersion =(typeof APP_VERSION !== 'undefined' ? APP_VERSION:'1.0.0').replace(/^v/,'');const versionKey = `v${currentVersion}`;return this.changelog[versionKey] || null;}getAllChangelogs(){const versions = Object.keys(this.changelog);const parseVersion =(versionStr)=>{const match = versionStr.match(/^v(\d+)\.(\d+)\.(\d+)\.(\d+)$/);if(match){const [,major,minor,patch,date] = match;return{major:parseInt(major),minor:parseInt(minor),patch:parseInt(patch),date:parseInt(date),original:versionStr};}return null;};const sortVersions =(a,b)=>{const versionA = parseVersion(a);const versionB = parseVersion(b);if(!versionA || !versionB)return 0;if(versionA.major !== versionB.major){return versionB.major - versionA.major;}if(versionA.minor !== versionB.minor){return versionB.minor - versionA.minor;}if(versionA.patch !== versionB.patch){return versionB.patch - versionA.patch;}return versionB.date - versionA.date;};return versions .sort(sortVersions).map(version => this.changelog[version]).filter(Boolean);}showChangelogDialog(version = null){const changelog = version ? this.changelog[version]:this.getCurrentVersionChangelog();if(!changelog){this.showErrorDialog('未找到对应版本的更新公告');return;}const dialog = document.createElement('div');dialog.className = 'changelog-dialog-overlay';dialog.innerHTML = ` <div class="changelog-dialog"> <div class="changelog-header"> <h3>${changelog.title}更新公告</h3> <span class="changelog-date">${changelog.date}</span> <button class="changelog-close" onclick="this.parentElement.parentElement.parentElement.remove()">×</button> </div> <div class="changelog-content"> <ul class="changelog-list"> ${changelog.features.map(feature => `<li>${feature}</li>`).join('')}</ul> </div> <div class="changelog-footer"> <button class="changelog-btn changelog-btn-primary" onclick="changelogManager.showAllChangelogs()">查看所有版本</button> <button class="changelog-btn changelog-btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">关闭</button> </div> </div> `;document.body.appendChild(dialog);dialog.addEventListener('click',(e)=>{if(e.target === dialog){dialog.remove();}});}showAllChangelogs(){const existingDialog = document.querySelector('.changelog-dialog-overlay');if(existingDialog){existingDialog.remove();}const allChangelogs = this.getAllChangelogs();const dialog = document.createElement('div');dialog.className = 'changelog-dialog-overlay';dialog.innerHTML = ` <div class="changelog-dialog changelog-dialog-large"> <div class="changelog-header"> <h3>所有版本更新公告</h3> <button class="changelog-close" onclick="this.parentElement.parentElement.parentElement.remove()">×</button> </div> <div class="changelog-content"> ${allChangelogs.map(changelog => ` <div class="changelog-version"> <div class="changelog-version-header"> <h4>${changelog.title}</h4> <span class="changelog-date">${changelog.date}</span> </div> <ul class="changelog-list"> ${changelog.features.map(feature => `<li>${feature}</li>`).join('')}</ul> </div> `).join('')}</div> <div class="changelog-footer"> <button class="changelog-btn changelog-btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">关闭</button> </div> </div> `;document.body.appendChild(dialog);dialog.addEventListener('click',(e)=>{if(e.target === dialog){dialog.remove();}});}showErrorDialog(message){const dialog = document.createElement('div');dialog.className = 'changelog-dialog-overlay';dialog.innerHTML = ` <div class="changelog-dialog changelog-dialog-small"> <div class="changelog-header"> <h3>提示</h3> <button class="changelog-close" onclick="this.parentElement.parentElement.parentElement.remove()">×</button> </div> <div class="changelog-content"> <p style="text-align:center;color:#666;margin:20px 0;">${message}</p> </div> <div class="changelog-footer"> <button class="changelog-btn changelog-btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">关闭</button> </div> </div> `;document.body.appendChild(dialog);dialog.addEventListener('click',(e)=>{if(e.target === dialog){dialog.remove();}});setTimeout(()=>{if(dialog.parentElement){dialog.remove();}},3000);}}const changelogManager = new ChangelogManager();class TimerManager{constructor(){this.totalTime = 120;this.remainingTime = 120;this.isRunning = false;this.intervalId = null;this.timerElement = null;this.displayElement = null;this.startButton = null;this.resetButton = null;this.init();}init(){this.timerElement = document.getElementById('timer');this.displayElement = document.getElementById('timerDisplay');this.startButton = document.getElementById('timerStartBtn');this.resetButton = document.getElementById('timerResetBtn');this.updateDisplay();this.bindEvents();}bindEvents(){this.makeTimerDraggable();}formatTime(seconds){const minutes = Math.floor(seconds / 60);const remainingSeconds = seconds % 60;return `${minutes.toString().padStart(2,'0')}:${remainingSeconds.toString().padStart(2,'0')}`;}updateDisplay(){if(!this.displayElement)return;this.displayElement.textContent = this.formatTime(this.remainingTime);this.displayElement.className = 'timer-display';if(this.remainingTime <= 30 && this.remainingTime > 10){this.displayElement.classList.add('warning');}else if(this.remainingTime <= 10){this.displayElement.classList.add('danger');}}start(){if(this.isRunning)return;this.isRunning = true;this.startButton.textContent = '暂停';this.startButton.className = 'timer-btn timer-btn-pause';this.displayElement.classList.add('blink');setTimeout(()=>{this.displayElement.classList.remove('blink');},300);this.intervalId = setInterval(()=>{this.remainingTime--;this.updateDisplay();if(this.remainingTime <= 0){this.stop();this.onTimeUp();}},1000);}pause(){if(!this.isRunning)return;this.isRunning = false;this.startButton.textContent = '开始';this.startButton.className = 'timer-btn timer-btn-start';if(this.intervalId){clearInterval(this.intervalId);this.intervalId = null;}this.displayElement.classList.add('blink');setTimeout(()=>{this.displayElement.classList.remove('blink');},300);}reset(){if(this.intervalId){clearInterval(this.intervalId);this.intervalId = null;}this.isRunning = false;this.remainingTime = this.totalTime;this.startButton.textContent = '开始';this.startButton.className = 'timer-btn timer-btn-start';this.updateDisplay();this.displayElement.classList.add('blink');setTimeout(()=>{this.displayElement.classList.remove('blink');},300);}stop(){this.pause();}onTimeUp(){this.remainingTime = 0;this.updateDisplay();this.displayElement.classList.add('highlight');setTimeout(()=>{this.displayElement.classList.remove('highlight');},3000);}toggle(){if(this.isRunning){this.pause();}else{this.start();}}resetTimerPosition(){if(!this.timerElement)return;this.timerElement.style.left = '20px';this.timerElement.style.bottom = '160px';this.timerElement.style.top = 'auto';this.timerElement.style.right = 'auto';this.timerElement.style.transform = 'none';localStorage.removeItem('timerPosition');}makeTimerDraggable(){if(!this.timerElement)return;const header = this.timerElement.querySelector('.timer-header');if(!header)return;let isDragging = false;let currentX;let currentY;let initialX;let initialY;let xOffset = 20;let yOffset = 160;let useBottomPosition = true;const savedPosition = localStorage.getItem('timerPosition');if(savedPosition){try{const position = JSON.parse(savedPosition);if(position.useBottom){this.timerElement.style.left = position.x + 'px';this.timerElement.style.bottom = position.y + 'px';this.timerElement.style.top = 'auto';this.timerElement.style.right = 'auto';this.timerElement.style.transform = 'none';xOffset = position.x;yOffset = position.y;useBottomPosition = true;}else{this.timerElement.style.left = position.x + 'px';this.timerElement.style.top = position.y + 'px';this.timerElement.style.bottom = 'auto';this.timerElement.style.right = 'auto';this.timerElement.style.transform = 'none';xOffset = position.x;yOffset = position.y;useBottomPosition = false;}}catch(e){this.resetTimerPosition();}}else{this.resetTimerPosition();}header.addEventListener('mousedown',dragStart);document.addEventListener('mousemove',drag);document.addEventListener('mouseup',dragEnd);function dragStart(e){if(e.target.tagName === 'BUTTON')return;const rect = timerManager.timerElement.getBoundingClientRect();initialX = e.clientX - rect.left;initialY = e.clientY - rect.top;if(e.target === header || header.contains(e.target)){isDragging = true;timerManager.timerElement.classList.add('dragging');}}function drag(e){if(isDragging){e.preventDefault();currentX = e.clientX - initialX;currentY = e.clientY - initialY;currentX = Math.max(0,Math.min(currentX,window.innerWidth - timerManager.timerElement.offsetWidth));currentY = Math.max(0,Math.min(currentY,window.innerHeight - timerManager.timerElement.offsetHeight));xOffset = currentX;yOffset = currentY;useBottomPosition = false;timerManager.timerElement.style.left = currentX + 'px';timerManager.timerElement.style.top = currentY + 'px';timerManager.timerElement.style.bottom = 'auto';timerManager.timerElement.style.right = 'auto';timerManager.timerElement.style.transform = 'none';}}function dragEnd(){if(isDragging){isDragging = false;timerManager.timerElement.classList.remove('dragging');localStorage.setItem('timerPosition',JSON.stringify({x:xOffset,y:yOffset,useBottom:useBottomPosition}));}}}}let timerManager;function toggleTimer(){if(timerManager){timerManager.toggle();}}function resetTimer(){if(timerManager){timerManager.reset();}}function initTimer(){timerManager = new TimerManager();}function toggleTimerVisibility(isVisible){const timer = document.getElementById('timer');if(timer){timer.style.display = isVisible ? 'block':'none';}localStorage.setItem('timerVisible',isVisible);}function initializeUIState(){const timerVisible = localStorage.getItem('timerVisible')=== 'true';const timerToggle = document.getElementById('timerVisibilityToggle');if(timerToggle){timerToggle.checked = timerVisible;}const timer = document.getElementById('timer');if(timer){timer.style.display = timerVisible ? 'block':'none';}}function initializeApplication(){document.getElementById('pageTitle').textContent = `${APP_NAME}${APP_VERSION}`;document.title = `${APP_NAME}${APP_VERSION}`;loadState();if(seats.length === 0){initSeats(12);}if(voteMap.length !== seats.length){voteMap = [];for(let i = 0;i < seats.length;i++)voteMap.push([]);}renderSeats();renderVoteArea();renderHistory();updateCounterDisplay();updatePhaseDisplay();initHistoryPanelDrag();initSeatPickerDrag();initPhasePanelDrag();initRoleFilterEvents();initDragHandlers();initGlobalKeyEvents();initTimer();initializeUIState();exposeGlobalFunctions();}function exposeGlobalFunctions(){window.updateName = updateName;window.selectName = selectName;window.clearName = clearName;window.setCounter = setCounter;window.changeCounter = changeCounter;window.handleCounterKeydown = handleCounterKeydown;window.showDropdown = showDropdown;window.showRoleFilterDialog = showRoleFilterDialog;window.resetAll = resetAll;window.copyVotes = copyVotes;window.resetVotes = resetVotes;window.onVoteAreaDrop = onVoteAreaDrop;window.toggleRoleCounters = toggleRoleCounters;window.clearHistory = clearHistory;window.deleteHistoryRecord = deleteHistoryRecord;window.copyHistoryRecord = copyHistoryRecord;window.exportHistory = exportHistory;window.handleNameEditKeyDown = handleNameEditKeyDown;window.handleNameEditKeyUp = handleNameEditKeyUp;window.toggleDayNight = toggleDayNight;window.changeDayCount = changeDayCount;window.prevPhaseStep = prevPhaseStep;window.nextPhaseStep = nextPhaseStep;window.pickRandomSeat = pickRandomSeat;window.setSkillPreset = setSkillPreset;window.toggleTimer = toggleTimer;window.resetTimer = resetTimer;window.toggleTimerVisibility = toggleTimerVisibility;}document.addEventListener('DOMContentLoaded',function(){initializeApplication();});window.initializeApplication = initializeApplication;
    </script>
</body>
</html>

<footer style="margin-top:40px; color:#333; font-size:14px; text-align:center;">
  <a href="https://github.com/Runwill/cyber-Xinshi" target="_blank">GitHub</a> <!--|
  <a href="https://space.bilibili.com/129368153" target="_blank">BiliBili</a>-->
</footer>
